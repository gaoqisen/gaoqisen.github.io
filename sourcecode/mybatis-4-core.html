<!DOCTYPE html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <title>04_Mybatisæºç -æ ¸å¿ƒåŒ… | HOME</title><meta name="description" content="Mybatisä¸‹è½½æºç è·Ÿç€debugä¸€éåè®°å½•ä¸€äº›æ¯”è¾ƒé‡è¦çš„æ³¨é‡Šï¼Œä¾¿äºä»¥åå›å¿†ä¾¿äºå­¦ä¹ ã€‚">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-59402a70.css" as="style"><link rel="stylesheet" href="/assets/style-59402a70.css">
    <link rel="modulepreload" href="/assets/app-f4339f74.js"><link rel="modulepreload" href="/assets/framework-6b2b1681.js"><link rel="modulepreload" href="/assets/mybatis-4-core.html-3305bd7d.js"><link rel="modulepreload" href="/assets/mybatis-4-core.html-6a5f8402.js"><link rel="prefetch" href="/assets/index.html-14ee54e4.js" as="script"><link rel="prefetch" href="/assets/CodeDiligenceWay.html-22c8c8ca.js" as="script"><link rel="prefetch" href="/assets/CriticalThinking.html-5a63ab6d.js" as="script"><link rel="prefetch" href="/assets/EffectiveJava.html-cc48ccdf.js" as="script"><link rel="prefetch" href="/assets/LearnQuestion.html-daab7963.js" as="script"><link rel="prefetch" href="/assets/TheCleanCoder.html-4ea72117.js" as="script"><link rel="prefetch" href="/assets/acmen.html-4877ed93.js" as="script"><link rel="prefetch" href="/assets/00basic.html-35ac94db.js" as="script"><link rel="prefetch" href="/assets/01dataStructrue.html-8689dc1b.js" as="script"><link rel="prefetch" href="/assets/02sort.html-7ec00896.js" as="script"><link rel="prefetch" href="/assets/03link.html-a1aaa4c5.js" as="script"><link rel="prefetch" href="/assets/04tree.html-b77a30ea.js" as="script"><link rel="prefetch" href="/assets/05greedy.html-42cc035b.js" as="script"><link rel="prefetch" href="/assets/06unionSet.html-881e1382.js" as="script"><link rel="prefetch" href="/assets/07graph.html-63b82412.js" as="script"><link rel="prefetch" href="/assets/08violentRecursion.html-1b2de2a3.js" as="script"><link rel="prefetch" href="/assets/09dp.html-2f14ecb7.js" as="script"><link rel="prefetch" href="/assets/10slidingWindow.html-424a29f0.js" as="script"><link rel="prefetch" href="/assets/11monotonousStack.html-c89c1feb.js" as="script"><link rel="prefetch" href="/assets/12fibonacciSkill.html-06a0aedb.js" as="script"><link rel="prefetch" href="/assets/13kmp.html-7682d977.js" as="script"><link rel="prefetch" href="/assets/14Manacher.html-397b81fd.js" as="script"><link rel="prefetch" href="/assets/15bfprt.html-7d159259.js" as="script"><link rel="prefetch" href="/assets/16reservoirSmpling.html-77f1e011.js" as="script"><link rel="prefetch" href="/assets/17morris.html-d1936688.js" as="script"><link rel="prefetch" href="/assets/18segmentIndexTreeAC.html-d554a85f.js" as="script"><link rel="prefetch" href="/assets/19hash.html-6a46a2ee.js" as="script"><link rel="prefetch" href="/assets/20orderedList.html-62abbd6a.js" as="script"><link rel="prefetch" href="/assets/elk.html-4b87891d.js" as="script"><link rel="prefetch" href="/assets/mysql0_base.html-e4639a94.js" as="script"><link rel="prefetch" href="/assets/mysql1_upgrade.html-5693b7f5.js" as="script"><link rel="prefetch" href="/assets/oracle.html-484eb97a.js" as="script"><link rel="prefetch" href="/assets/MyAndYou.html-6c36dde4.js" as="script"><link rel="prefetch" href="/assets/chengdu.html-65306cd9.js" as="script"><link rel="prefetch" href="/assets/phrase.html-09ccf59c.js" as="script"><link rel="prefetch" href="/assets/target.html-4aaf5452.js" as="script"><link rel="prefetch" href="/assets/command.html-9a1a3432.js" as="script"><link rel="prefetch" href="/assets/curl.html-c91387fb.js" as="script"><link rel="prefetch" href="/assets/git.html-7932c119.js" as="script"><link rel="prefetch" href="/assets/git_rsync.html-532980b5.js" as="script"><link rel="prefetch" href="/assets/gtilab.html-87b96605.js" as="script"><link rel="prefetch" href="/assets/jenkins.html-5d14a088.js" as="script"><link rel="prefetch" href="/assets/kubernetes.html-e8c3c22a.js" as="script"><link rel="prefetch" href="/assets/nginx.html-d0bd2fbd.js" as="script"><link rel="prefetch" href="/assets/vim.html-c806b024.js" as="script"><link rel="prefetch" href="/assets/vpn.html-b36fc4bd.js" as="script"><link rel="prefetch" href="/assets/AsyncManager.html-b62ea14d.js" as="script"><link rel="prefetch" href="/assets/HttpUtils.html-09e7de23.js" as="script"><link rel="prefetch" href="/assets/LogAspect.html-471473f5.js" as="script"><link rel="prefetch" href="/assets/RedisService.html-55322198.js" as="script"><link rel="prefetch" href="/assets/annotation.html-eff68c09.js" as="script"><link rel="prefetch" href="/assets/classloader.html-a29b3a3f.js" as="script"><link rel="prefetch" href="/assets/codeIssue.html-4dd55109.js" as="script"><link rel="prefetch" href="/assets/commomUse.html-9f704e28.js" as="script"><link rel="prefetch" href="/assets/distributed.html-d115f090.js" as="script"><link rel="prefetch" href="/assets/easyCodeTemplate.html-54706ea6.js" as="script"><link rel="prefetch" href="/assets/enum.html-4f3f2863.js" as="script"><link rel="prefetch" href="/assets/gc.html-534622c0.js" as="script"><link rel="prefetch" href="/assets/io.html-30cad8d9.js" as="script"><link rel="prefetch" href="/assets/jvm.html-36959ad2.js" as="script"><link rel="prefetch" href="/assets/lock.html-ca79c517.js" as="script"><link rel="prefetch" href="/assets/maven.html-5efdd188.js" as="script"><link rel="prefetch" href="/assets/netty.html-f940559d.js" as="script"><link rel="prefetch" href="/assets/nio.html-077f277e.js" as="script"><link rel="prefetch" href="/assets/reference.html-cef0378e.js" as="script"><link rel="prefetch" href="/assets/skill.html-80602bb4.js" as="script"><link rel="prefetch" href="/assets/socket.html-593623c1.js" as="script"><link rel="prefetch" href="/assets/threadSecurity.html-270e2c5b.js" as="script"><link rel="prefetch" href="/assets/view_flow.html-d4159e33.js" as="script"><link rel="prefetch" href="/assets/webCenter2.0.html-107a93cd.js" as="script"><link rel="prefetch" href="/assets/webJsonToken.html-7873fd0d.js" as="script"><link rel="prefetch" href="/assets/01DesignPettern.html-506f20ed.js" as="script"><link rel="prefetch" href="/assets/02MultiThread.html-15a77e7a.js" as="script"><link rel="prefetch" href="/assets/03Product.html-d6b9ee25.js" as="script"><link rel="prefetch" href="/assets/filebeat.html-898fad30.js" as="script"><link rel="prefetch" href="/assets/leaf.html-03ee9b5a.js" as="script"><link rel="prefetch" href="/assets/logstash.html-0c823b02.js" as="script"><link rel="prefetch" href="/assets/mycat.html-89701581.js" as="script"><link rel="prefetch" href="/assets/nacos.html-f81ec53d.js" as="script"><link rel="prefetch" href="/assets/redis.html-38d12a77.js" as="script"><link rel="prefetch" href="/assets/rocketmq.html-855d3075.js" as="script"><link rel="prefetch" href="/assets/skyWalking.html-fc946146.js" as="script"><link rel="prefetch" href="/assets/tomcatService.html-794299a3.js" as="script"><link rel="prefetch" href="/assets/OSI.html-4a98acf2.js" as="script"><link rel="prefetch" href="/assets/TCPIP.html-d68c1142.js" as="script"><link rel="prefetch" href="/assets/base.html-7f188dc0.js" as="script"><link rel="prefetch" href="/assets/reverseProxy.html-e4d204a7.js" as="script"><link rel="prefetch" href="/assets/alfred.html-5f6efdea.js" as="script"><link rel="prefetch" href="/assets/mac_command.html-e9ea3e0b.js" as="script"><link rel="prefetch" href="/assets/online_utils.html-1b01e695.js" as="script"><link rel="prefetch" href="/assets/bridge.html-ffa93593.js" as="script"><link rel="prefetch" href="/assets/builder.html-b0b392a2.js" as="script"><link rel="prefetch" href="/assets/chain_ofResponsibilitys.html-e98b76c9.js" as="script"><link rel="prefetch" href="/assets/chain_of_responsibility.html-e575bbf4.js" as="script"><link rel="prefetch" href="/assets/command.html-1194767f.js" as="script"><link rel="prefetch" href="/assets/component.html-acd171e0.js" as="script"><link rel="prefetch" href="/assets/decorate.html-e51f10e7.js" as="script"><link rel="prefetch" href="/assets/facade.html-83969f36.js" as="script"><link rel="prefetch" href="/assets/factory.html-e60a6bf7.js" as="script"><link rel="prefetch" href="/assets/interpreter.html-b7324fe0.js" as="script"><link rel="prefetch" href="/assets/iterator.html-631c845f.js" as="script"><link rel="prefetch" href="/assets/mediator.html-60cc5948.js" as="script"><link rel="prefetch" href="/assets/memento.html-14a57570.js" as="script"><link rel="prefetch" href="/assets/observable.html-a8d79892.js" as="script"><link rel="prefetch" href="/assets/observe.html-e5142302.js" as="script"><link rel="prefetch" href="/assets/prototype.html-5a866557.js" as="script"><link rel="prefetch" href="/assets/proxy.html-7152dea8.js" as="script"><link rel="prefetch" href="/assets/single.html-edf663a7.js" as="script"><link rel="prefetch" href="/assets/state.html-07b4e475.js" as="script"><link rel="prefetch" href="/assets/strategy.html-c0dacbdd.js" as="script"><link rel="prefetch" href="/assets/sum.html-14f86486.js" as="script"><link rel="prefetch" href="/assets/template.html-ec93db1c.js" as="script"><link rel="prefetch" href="/assets/visitor.html-6df0dc46.js" as="script"><link rel="prefetch" href="/assets/multiDataSource.html-ba6c704c.js" as="script"><link rel="prefetch" href="/assets/mybatis-1-flow.html-78edea5c.js" as="script"><link rel="prefetch" href="/assets/mybatis-2-basePackage.html-952535a6.js" as="script"><link rel="prefetch" href="/assets/mybatis-3-configParse.html-bff5a259.js" as="script"><link rel="prefetch" href="/assets/mybatis-5-sum.html-ace9cde8.js" as="script"><link rel="prefetch" href="/assets/spring-1-DLBF.html-30027af4.js" as="script"><link rel="prefetch" href="/assets/spring-2-CPXAC.html-1b3e40bb.js" as="script"><link rel="prefetch" href="/assets/assembly.html-800cad9a.js" as="script"><link rel="prefetch" href="/assets/c__.html-6afe1f95.js" as="script"><link rel="prefetch" href="/assets/computerNetworkTheory.html-6bc89b8b.js" as="script"><link rel="prefetch" href="/assets/interview.html-8bea1793.js" as="script"><link rel="prefetch" href="/assets/java.html-5c875483.js" as="script"><link rel="prefetch" href="/assets/software.html-2b8d796d.js" as="script"><link rel="prefetch" href="/assets/study.html-7ee64f59.js" as="script"><link rel="prefetch" href="/assets/train.html-c2779c8e.js" as="script"><link rel="prefetch" href="/assets/work_20221011.html-f273bb04.js" as="script"><link rel="prefetch" href="/assets/docker.html-c00ba1d0.js" as="script"><link rel="prefetch" href="/assets/dockerRsync.html-43148e8e.js" as="script"><link rel="prefetch" href="/assets/hadoop.html-7a82e5b2.js" as="script"><link rel="prefetch" href="/assets/idea.html-e246cc50.js" as="script"><link rel="prefetch" href="/assets/mindoc.html-99fba6e9.js" as="script"><link rel="prefetch" href="/assets/regex.html-36a2f239.js" as="script"><link rel="prefetch" href="/assets/springCloud.html-372d73cb.js" as="script"><link rel="prefetch" href="/assets/jqueryForm.html-06d3371a.js" as="script"><link rel="prefetch" href="/assets/vueBase.html-ffa99a3f.js" as="script"><link rel="prefetch" href="/assets/01åŸºæœ¬æ¡†æ¶.html-ee9b6fca.js" as="script"><link rel="prefetch" href="/assets/11åŠ¨è¯.html-d2e39a60.js" as="script"><link rel="prefetch" href="/assets/12åè¯.html-cea1e04a.js" as="script"><link rel="prefetch" href="/assets/13å½¢å®¹è¯.html-c4ac1d0b.js" as="script"><link rel="prefetch" href="/assets/14å‰¯è¯.html-562ebe92.js" as="script"><link rel="prefetch" href="/assets/21æ•°è¯.html-1db06fe5.js" as="script"><link rel="prefetch" href="/assets/22å† è¯.html-57a3b13d.js" as="script"><link rel="prefetch" href="/assets/23ä»£è¯.html-7ed27177.js" as="script"><link rel="prefetch" href="/assets/24ä»‹è¯.html-a3140347.js" as="script"><link rel="prefetch" href="/assets/25è¿è¯.html-dfd92655.js" as="script"><link rel="prefetch" href="/assets/31ç®€å•å¥.html-37ba8f3d.js" as="script"><link rel="prefetch" href="/assets/32ä»å¥.html-28831977.js" as="script"><link rel="prefetch" href="/assets/32å¤æ‚å¥.html-fc72e4b2.js" as="script"><link rel="prefetch" href="/assets/01éŸ³æ ‡.html-2f3b9f20.js" as="script"><link rel="prefetch" href="/assets/02åŒä¹‰è¯.html-4db41374.js" as="script"><link rel="prefetch" href="/assets/03å¥å­.html-5aadc723.js" as="script"><link rel="prefetch" href="/assets/04å½’ç±»è®°å¿†.html-cbbbe18e.js" as="script"><link rel="prefetch" href="/assets/05è¯ä¼™è®°å¿†1.html-c382b7ab.js" as="script"><link rel="prefetch" href="/assets/05è¯ä¼™è®°å¿†2.html-4397fb2b.js" as="script"><link rel="prefetch" href="/assets/06çŸ­è¯­.html-4aeeac31.js" as="script"><link rel="prefetch" href="/assets/06è¯ä¼™è®°å¿† 3.html-1384f76c.js" as="script"><link rel="prefetch" href="/assets/07å°ç‹å­.html-774d0cf1.js" as="script"><link rel="prefetch" href="/assets/08è€äººä¸æµ·.html-970551b0.js" as="script"><link rel="prefetch" href="/assets/09æ˜“æ··æ·†.html-0a9f44e2.js" as="script"><link rel="prefetch" href="/assets/10æ‹¼æ¥è¯.html-a97aa915.js" as="script"><link rel="prefetch" href="/assets/404.html-787fe5c4.js" as="script"><link rel="prefetch" href="/assets/index.html-fb901e13.js" as="script"><link rel="prefetch" href="/assets/index.html-5e659016.js" as="script"><link rel="prefetch" href="/assets/index.html-2334f86d.js" as="script"><link rel="prefetch" href="/assets/index.html-1d00a34d.js" as="script"><link rel="prefetch" href="/assets/index.html-d998b18f.js" as="script"><link rel="prefetch" href="/assets/index.html-189a1931.js" as="script"><link rel="prefetch" href="/assets/index.html-2bd1a8a7.js" as="script"><link rel="prefetch" href="/assets/index.html-8cb11943.js" as="script"><link rel="prefetch" href="/assets/index.html-7bb5bf9c.js" as="script"><link rel="prefetch" href="/assets/index.html-bd61b0e3.js" as="script"><link rel="prefetch" href="/assets/index.html-80757ebb.js" as="script"><link rel="prefetch" href="/assets/index.html-1a90d3ba.js" as="script"><link rel="prefetch" href="/assets/index.html-41e55e53.js" as="script"><link rel="prefetch" href="/assets/index.html-d42eefdd.js" as="script"><link rel="prefetch" href="/assets/index.html-837627da.js" as="script"><link rel="prefetch" href="/assets/index.html-7b14a6f0.js" as="script"><link rel="prefetch" href="/assets/index.html-c0c8366f.js" as="script"><link rel="prefetch" href="/assets/index.html-89691a45.js" as="script"><link rel="prefetch" href="/assets/index.html-d8149391.js" as="script"><link rel="prefetch" href="/assets/CodeDiligenceWay.html-a39ab80c.js" as="script"><link rel="prefetch" href="/assets/CriticalThinking.html-e2906c57.js" as="script"><link rel="prefetch" href="/assets/EffectiveJava.html-e85fdcbb.js" as="script"><link rel="prefetch" href="/assets/LearnQuestion.html-dd205ed9.js" as="script"><link rel="prefetch" href="/assets/TheCleanCoder.html-073b340c.js" as="script"><link rel="prefetch" href="/assets/acmen.html-24d230cb.js" as="script"><link rel="prefetch" href="/assets/00basic.html-69633b2f.js" as="script"><link rel="prefetch" href="/assets/01dataStructrue.html-67a4cbdd.js" as="script"><link rel="prefetch" href="/assets/02sort.html-6d52f6c2.js" as="script"><link rel="prefetch" href="/assets/03link.html-6f40b2f5.js" as="script"><link rel="prefetch" href="/assets/04tree.html-6427aa81.js" as="script"><link rel="prefetch" href="/assets/05greedy.html-fa2134da.js" as="script"><link rel="prefetch" href="/assets/06unionSet.html-daced349.js" as="script"><link rel="prefetch" href="/assets/07graph.html-2ccd23d3.js" as="script"><link rel="prefetch" href="/assets/08violentRecursion.html-03cc4ec2.js" as="script"><link rel="prefetch" href="/assets/09dp.html-fc59834e.js" as="script"><link rel="prefetch" href="/assets/10slidingWindow.html-fd8460f0.js" as="script"><link rel="prefetch" href="/assets/11monotonousStack.html-56947c86.js" as="script"><link rel="prefetch" href="/assets/12fibonacciSkill.html-440cc2a5.js" as="script"><link rel="prefetch" href="/assets/13kmp.html-8ef85b56.js" as="script"><link rel="prefetch" href="/assets/14Manacher.html-eb68a2bc.js" as="script"><link rel="prefetch" href="/assets/15bfprt.html-c8406a0c.js" as="script"><link rel="prefetch" href="/assets/16reservoirSmpling.html-8092e5e5.js" as="script"><link rel="prefetch" href="/assets/17morris.html-f7261490.js" as="script"><link rel="prefetch" href="/assets/18segmentIndexTreeAC.html-84313a3c.js" as="script"><link rel="prefetch" href="/assets/19hash.html-5dd8198e.js" as="script"><link rel="prefetch" href="/assets/20orderedList.html-f8089195.js" as="script"><link rel="prefetch" href="/assets/elk.html-ebf0c8a7.js" as="script"><link rel="prefetch" href="/assets/mysql0_base.html-e6a8ec98.js" as="script"><link rel="prefetch" href="/assets/mysql1_upgrade.html-1fe9e3f2.js" as="script"><link rel="prefetch" href="/assets/oracle.html-8b01ac1a.js" as="script"><link rel="prefetch" href="/assets/MyAndYou.html-b9a101cb.js" as="script"><link rel="prefetch" href="/assets/chengdu.html-2832c2ca.js" as="script"><link rel="prefetch" href="/assets/phrase.html-8081aef1.js" as="script"><link rel="prefetch" href="/assets/target.html-75ab75ce.js" as="script"><link rel="prefetch" href="/assets/command.html-5658953b.js" as="script"><link rel="prefetch" href="/assets/curl.html-ffa87cf3.js" as="script"><link rel="prefetch" href="/assets/git.html-3b3d3e43.js" as="script"><link rel="prefetch" href="/assets/git_rsync.html-7933812d.js" as="script"><link rel="prefetch" href="/assets/gtilab.html-78f72f81.js" as="script"><link rel="prefetch" href="/assets/jenkins.html-c72fc37e.js" as="script"><link rel="prefetch" href="/assets/kubernetes.html-afb7c060.js" as="script"><link rel="prefetch" href="/assets/nginx.html-46872cac.js" as="script"><link rel="prefetch" href="/assets/vim.html-1f35a096.js" as="script"><link rel="prefetch" href="/assets/vpn.html-6f4cd6dc.js" as="script"><link rel="prefetch" href="/assets/AsyncManager.html-a8b014e3.js" as="script"><link rel="prefetch" href="/assets/HttpUtils.html-b804999f.js" as="script"><link rel="prefetch" href="/assets/LogAspect.html-eaa6ff4f.js" as="script"><link rel="prefetch" href="/assets/RedisService.html-72787937.js" as="script"><link rel="prefetch" href="/assets/annotation.html-e54c9064.js" as="script"><link rel="prefetch" href="/assets/classloader.html-9b88f8ba.js" as="script"><link rel="prefetch" href="/assets/codeIssue.html-88fbf4c4.js" as="script"><link rel="prefetch" href="/assets/commomUse.html-6cb39395.js" as="script"><link rel="prefetch" href="/assets/distributed.html-121dfdb6.js" as="script"><link rel="prefetch" href="/assets/easyCodeTemplate.html-0bf7964f.js" as="script"><link rel="prefetch" href="/assets/enum.html-d3581f52.js" as="script"><link rel="prefetch" href="/assets/gc.html-0d76a7a8.js" as="script"><link rel="prefetch" href="/assets/io.html-e5b6c34b.js" as="script"><link rel="prefetch" href="/assets/jvm.html-3e216f4d.js" as="script"><link rel="prefetch" href="/assets/lock.html-61bd8508.js" as="script"><link rel="prefetch" href="/assets/maven.html-8ad260eb.js" as="script"><link rel="prefetch" href="/assets/netty.html-170b6533.js" as="script"><link rel="prefetch" href="/assets/nio.html-21ad0eee.js" as="script"><link rel="prefetch" href="/assets/reference.html-145aa4ed.js" as="script"><link rel="prefetch" href="/assets/skill.html-7f1b728a.js" as="script"><link rel="prefetch" href="/assets/socket.html-eb2dc024.js" as="script"><link rel="prefetch" href="/assets/threadSecurity.html-ccc1ac0b.js" as="script"><link rel="prefetch" href="/assets/view_flow.html-6a8a28a1.js" as="script"><link rel="prefetch" href="/assets/webCenter2.0.html-c8531baf.js" as="script"><link rel="prefetch" href="/assets/webJsonToken.html-0a0e41fc.js" as="script"><link rel="prefetch" href="/assets/01DesignPettern.html-c80d8fdc.js" as="script"><link rel="prefetch" href="/assets/02MultiThread.html-45d70548.js" as="script"><link rel="prefetch" href="/assets/03Product.html-47d0eb81.js" as="script"><link rel="prefetch" href="/assets/filebeat.html-e18c4f63.js" as="script"><link rel="prefetch" href="/assets/leaf.html-f07d96ac.js" as="script"><link rel="prefetch" href="/assets/logstash.html-1e7982f3.js" as="script"><link rel="prefetch" href="/assets/mycat.html-0b6cc145.js" as="script"><link rel="prefetch" href="/assets/nacos.html-796fa429.js" as="script"><link rel="prefetch" href="/assets/redis.html-53c6cc96.js" as="script"><link rel="prefetch" href="/assets/rocketmq.html-f5894649.js" as="script"><link rel="prefetch" href="/assets/skyWalking.html-4f680b5d.js" as="script"><link rel="prefetch" href="/assets/tomcatService.html-e7dbf869.js" as="script"><link rel="prefetch" href="/assets/OSI.html-09ed62e9.js" as="script"><link rel="prefetch" href="/assets/TCPIP.html-6c87994e.js" as="script"><link rel="prefetch" href="/assets/base.html-0c6d25e5.js" as="script"><link rel="prefetch" href="/assets/reverseProxy.html-6d28a52c.js" as="script"><link rel="prefetch" href="/assets/alfred.html-54a720fc.js" as="script"><link rel="prefetch" href="/assets/mac_command.html-7b5fad3b.js" as="script"><link rel="prefetch" href="/assets/online_utils.html-c6b8694e.js" as="script"><link rel="prefetch" href="/assets/bridge.html-ae5273b6.js" as="script"><link rel="prefetch" href="/assets/builder.html-a0e8335f.js" as="script"><link rel="prefetch" href="/assets/chain_ofResponsibilitys.html-823632b4.js" as="script"><link rel="prefetch" href="/assets/chain_of_responsibility.html-1b9dc88d.js" as="script"><link rel="prefetch" href="/assets/command.html-bb29fa79.js" as="script"><link rel="prefetch" href="/assets/component.html-c91d510f.js" as="script"><link rel="prefetch" href="/assets/decorate.html-83c603cf.js" as="script"><link rel="prefetch" href="/assets/facade.html-997705ea.js" as="script"><link rel="prefetch" href="/assets/factory.html-829c43d8.js" as="script"><link rel="prefetch" href="/assets/interpreter.html-13253e05.js" as="script"><link rel="prefetch" href="/assets/iterator.html-1bb8a4df.js" as="script"><link rel="prefetch" href="/assets/mediator.html-d5536920.js" as="script"><link rel="prefetch" href="/assets/memento.html-b2f589b0.js" as="script"><link rel="prefetch" href="/assets/observable.html-97e7998f.js" as="script"><link rel="prefetch" href="/assets/observe.html-b1b6ad5d.js" as="script"><link rel="prefetch" href="/assets/prototype.html-0d84d2c8.js" as="script"><link rel="prefetch" href="/assets/proxy.html-b45d74cb.js" as="script"><link rel="prefetch" href="/assets/single.html-fb749c4e.js" as="script"><link rel="prefetch" href="/assets/state.html-ae674137.js" as="script"><link rel="prefetch" href="/assets/strategy.html-d338c5c6.js" as="script"><link rel="prefetch" href="/assets/sum.html-bd781ad4.js" as="script"><link rel="prefetch" href="/assets/template.html-a221e64b.js" as="script"><link rel="prefetch" href="/assets/visitor.html-6021fa46.js" as="script"><link rel="prefetch" href="/assets/multiDataSource.html-dc59e9f2.js" as="script"><link rel="prefetch" href="/assets/mybatis-1-flow.html-78c23745.js" as="script"><link rel="prefetch" href="/assets/mybatis-2-basePackage.html-7cfb6802.js" as="script"><link rel="prefetch" href="/assets/mybatis-3-configParse.html-0769fb46.js" as="script"><link rel="prefetch" href="/assets/mybatis-5-sum.html-3dda1ace.js" as="script"><link rel="prefetch" href="/assets/spring-1-DLBF.html-6a131ebd.js" as="script"><link rel="prefetch" href="/assets/spring-2-CPXAC.html-a47e3683.js" as="script"><link rel="prefetch" href="/assets/assembly.html-d21fc70b.js" as="script"><link rel="prefetch" href="/assets/c__.html-25b2cb30.js" as="script"><link rel="prefetch" href="/assets/computerNetworkTheory.html-29e0e6ed.js" as="script"><link rel="prefetch" href="/assets/interview.html-a7fbfc66.js" as="script"><link rel="prefetch" href="/assets/java.html-aad44f08.js" as="script"><link rel="prefetch" href="/assets/software.html-fd5e12c1.js" as="script"><link rel="prefetch" href="/assets/study.html-e3c2b5c1.js" as="script"><link rel="prefetch" href="/assets/train.html-14fd3bc0.js" as="script"><link rel="prefetch" href="/assets/work_20221011.html-e91440e8.js" as="script"><link rel="prefetch" href="/assets/docker.html-2cd2211b.js" as="script"><link rel="prefetch" href="/assets/dockerRsync.html-23139fb9.js" as="script"><link rel="prefetch" href="/assets/hadoop.html-99fadd38.js" as="script"><link rel="prefetch" href="/assets/idea.html-3076c78f.js" as="script"><link rel="prefetch" href="/assets/mindoc.html-8f79fd9c.js" as="script"><link rel="prefetch" href="/assets/regex.html-843cf51d.js" as="script"><link rel="prefetch" href="/assets/springCloud.html-a7661248.js" as="script"><link rel="prefetch" href="/assets/jqueryForm.html-320de07f.js" as="script"><link rel="prefetch" href="/assets/vueBase.html-8ca46c94.js" as="script"><link rel="prefetch" href="/assets/01åŸºæœ¬æ¡†æ¶.html-bedf481e.js" as="script"><link rel="prefetch" href="/assets/11åŠ¨è¯.html-f8722739.js" as="script"><link rel="prefetch" href="/assets/12åè¯.html-652e3cb5.js" as="script"><link rel="prefetch" href="/assets/13å½¢å®¹è¯.html-f200c2bf.js" as="script"><link rel="prefetch" href="/assets/14å‰¯è¯.html-67989c60.js" as="script"><link rel="prefetch" href="/assets/21æ•°è¯.html-194d16a0.js" as="script"><link rel="prefetch" href="/assets/22å† è¯.html-cf17b908.js" as="script"><link rel="prefetch" href="/assets/23ä»£è¯.html-f0c4ab18.js" as="script"><link rel="prefetch" href="/assets/24ä»‹è¯.html-b637079b.js" as="script"><link rel="prefetch" href="/assets/25è¿è¯.html-0b1323e5.js" as="script"><link rel="prefetch" href="/assets/31ç®€å•å¥.html-59bfca9e.js" as="script"><link rel="prefetch" href="/assets/32ä»å¥.html-f98174dc.js" as="script"><link rel="prefetch" href="/assets/32å¤æ‚å¥.html-3d1d1314.js" as="script"><link rel="prefetch" href="/assets/01éŸ³æ ‡.html-a42e47bc.js" as="script"><link rel="prefetch" href="/assets/02åŒä¹‰è¯.html-e4053e87.js" as="script"><link rel="prefetch" href="/assets/03å¥å­.html-55aa69e1.js" as="script"><link rel="prefetch" href="/assets/04å½’ç±»è®°å¿†.html-14cdab0c.js" as="script"><link rel="prefetch" href="/assets/05è¯ä¼™è®°å¿†1.html-4aa4db90.js" as="script"><link rel="prefetch" href="/assets/05è¯ä¼™è®°å¿†2.html-ad66beaa.js" as="script"><link rel="prefetch" href="/assets/06çŸ­è¯­.html-238ee2e7.js" as="script"><link rel="prefetch" href="/assets/06è¯ä¼™è®°å¿† 3.html-97bdfdba.js" as="script"><link rel="prefetch" href="/assets/07å°ç‹å­.html-f58f7b0d.js" as="script"><link rel="prefetch" href="/assets/08è€äººä¸æµ·.html-31e95675.js" as="script"><link rel="prefetch" href="/assets/09æ˜“æ··æ·†.html-8f5becf8.js" as="script"><link rel="prefetch" href="/assets/10æ‹¼æ¥è¯.html-0b7e11fd.js" as="script"><link rel="prefetch" href="/assets/404.html-b9bd2d87.js" as="script"><link rel="prefetch" href="/assets/index.html-e123dbfb.js" as="script"><link rel="prefetch" href="/assets/index.html-f7207b30.js" as="script"><link rel="prefetch" href="/assets/index.html-aeeaf98c.js" as="script"><link rel="prefetch" href="/assets/index.html-a06a8e43.js" as="script"><link rel="prefetch" href="/assets/index.html-f3bf9a41.js" as="script"><link rel="prefetch" href="/assets/index.html-5947fcec.js" as="script"><link rel="prefetch" href="/assets/index.html-d51f4b51.js" as="script"><link rel="prefetch" href="/assets/index.html-94cc96cb.js" as="script"><link rel="prefetch" href="/assets/index.html-fe0ea5d7.js" as="script"><link rel="prefetch" href="/assets/index.html-fbd61fd4.js" as="script"><link rel="prefetch" href="/assets/index.html-f2fe89e7.js" as="script"><link rel="prefetch" href="/assets/index.html-4ea04cf1.js" as="script"><link rel="prefetch" href="/assets/index.html-498efb1e.js" as="script"><link rel="prefetch" href="/assets/index.html-4273a498.js" as="script"><link rel="prefetch" href="/assets/index.html-ee607ba6.js" as="script"><link rel="prefetch" href="/assets/index.html-dc031e84.js" as="script"><link rel="prefetch" href="/assets/index.html-7f95198b.js" as="script"><link rel="prefetch" href="/assets/index.html-b3e09f67.js" as="script"><link rel="prefetch" href="/assets/plyr.min-4a928d69.js" as="script"><link rel="prefetch" href="/assets/plyr.min-4a928d69.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-6e6cbe40.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to main content</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><!----><!----><span class="site-name">HOME</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><!----><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><!----><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/" class="nav-link sidebar-link sidebar-page" aria-label="home"><span class="font-icon icon home" style=""></span>home<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Algorithm</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Book</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Database</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">English</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Life</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Linux</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Mca</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Middleware</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Network</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Other</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Pattern</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">Sourcecode</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/sourcecode/multiDataSource.html" class="nav-link sidebar-link sidebar-page" aria-label="00_å¤šæ•°æ®æºå®ç°"><!---->00_å¤šæ•°æ®æºå®ç°<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/sourcecode/mybatis-1-flow.html" class="nav-link sidebar-link sidebar-page" aria-label="01_Mybatisæºç -åˆæ¢æµç¨‹"><!---->01_Mybatisæºç -åˆæ¢æµç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/sourcecode/mybatis-2-basePackage.html" class="nav-link sidebar-link sidebar-page" aria-label="02_Mybatisæºç -åŸºç¡€åŒ…"><!---->02_Mybatisæºç -åŸºç¡€åŒ…<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/sourcecode/mybatis-3-configParse.html" class="nav-link sidebar-link sidebar-page" aria-label="03_Mybatisæºç -é…ç½®è§£æ"><!---->03_Mybatisæºç -é…ç½®è§£æ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/sourcecode/mybatis-4-core.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="04_Mybatisæºç -æ ¸å¿ƒåŒ…"><!---->04_Mybatisæºç -æ ¸å¿ƒåŒ…<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#ä¸€ã€æºç é˜…è¯»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ä¸€ã€æºç é˜…è¯»"><!---->ä¸€ã€æºç é˜…è¯»<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#_1-1-jdbcåŒ…" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.1 jdbcåŒ…"><!---->1.1 jdbcåŒ…<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#_1-2-cacheåŒ…" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.2 cacheåŒ…"><!---->1.2 cacheåŒ…<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#_1-3-transactionåŒ…" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.3 transactionåŒ…"><!---->1.3 transactionåŒ…<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#_1-4-cursoråŒ…" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.4 cursoråŒ…"><!---->1.4 cursoråŒ…<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#_1-5-executoråŒ…" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.5 executoråŒ…"><!---->1.5 executoråŒ…<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#_1-6-sessionåŒ…" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.6 sessionåŒ…"><!---->1.6 sessionåŒ…<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#_1-7-pluginåŒ…" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.7 pluginåŒ…"><!---->1.7 pluginåŒ…<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#äºŒã€åŒ…ç»“æ„æ±‡æ€»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="äºŒã€åŒ…ç»“æ„æ±‡æ€»"><!---->äºŒã€åŒ…ç»“æ„æ±‡æ€»<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/sourcecode/mybatis-5-sum.html" class="nav-link sidebar-link sidebar-page" aria-label="05_Mybatisæºç -æ±‡æ€»"><!---->05_Mybatisæºç -æ±‡æ€»<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/sourcecode/spring-1-DLBF.html" class="nav-link sidebar-link sidebar-page" aria-label="06_Springæºç (ä¸€)-åˆæ¢æµç¨‹"><!---->06_Springæºç (ä¸€)-åˆæ¢æµç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/sourcecode/spring-2-CPXAC.html" class="nav-link sidebar-link sidebar-page" aria-label="07_Springæºç (äºŒ)-å®¹å™¨åˆå§‹åŒ–"><!---->07_Springæºç (äºŒ)-å®¹å™¨åˆå§‹åŒ–<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Study</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Tool</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Web</span><span class="arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->04_Mybatisæºç -æ ¸å¿ƒåŒ…</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="Writing DateğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2021-08-09T21:43:40.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading TimeâŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 40 min</span><meta property="timeRequired" content="PT40M"></span><span class="page-category-info" aria-label="CategoryğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="page-category-item category6" role>sourcecode</span><meta property="articleSection" content="sourcecode"></span><span class="page-tag-info" aria-label="TagğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="page-tag-item tag6" role>sourcecode</span><meta property="keywords" content="sourcecode"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">On This Page<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#ä¸€ã€æºç é˜…è¯»" class="router-link-active router-link-exact-active toc-link level2">ä¸€ã€æºç é˜…è¯»</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#_1-1-jdbcåŒ…" class="router-link-active router-link-exact-active toc-link level3">1.1 jdbcåŒ…</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#_1-2-cacheåŒ…" class="router-link-active router-link-exact-active toc-link level3">1.2 cacheåŒ…</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#_1-3-transactionåŒ…" class="router-link-active router-link-exact-active toc-link level3">1.3 transactionåŒ…</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#_1-4-cursoråŒ…" class="router-link-active router-link-exact-active toc-link level3">1.4 cursoråŒ…</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#_1-5-executoråŒ…" class="router-link-active router-link-exact-active toc-link level3">1.5 executoråŒ…</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#_1-6-sessionåŒ…" class="router-link-active router-link-exact-active toc-link level3">1.6 sessionåŒ…</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#_1-7-pluginåŒ…" class="router-link-active router-link-exact-active toc-link level3">1.7 pluginåŒ…</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/sourcecode/mybatis-4-core.html#äºŒã€åŒ…ç»“æ„æ±‡æ€»" class="router-link-active router-link-exact-active toc-link level2">äºŒã€åŒ…ç»“æ„æ±‡æ€»</a></li><!----><!--]--></ul></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h2 id="ä¸€ã€æºç é˜…è¯»" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€æºç é˜…è¯»" aria-hidden="true">#</a> ä¸€ã€æºç é˜…è¯»</h2><p>ä¸»è¦é˜…è¯»jdbcåŒ…ã€cacheåŒ…ã€transactionåŒ…ã€cursoråŒ…ã€executoråŒ…ã€sessionåŒ…ã€pluginåŒ…</p><h3 id="_1-1-jdbcåŒ…" tabindex="-1"><a class="header-anchor" href="#_1-1-jdbcåŒ…" aria-hidden="true">#</a> 1.1 jdbcåŒ…</h3><p>jdbcåŒ…æä¾›äº†æ•°æ®åº“æ“ä½œè¯­è¨€çš„æ‰§è¡Œå’Œè„šæœ¬è¿è¡Œçš„èƒ½åŠ›ï¼Œè¿™ä¸ªåŒ…æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åŒ…ï¼Œå…¶ä»–åœ°æ–¹éƒ½æ²¡æœ‰ä½¿ç”¨æ˜¯æä¾›å‡ºæ¥æ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨çš„ï¼Œå¯ä»¥ç”¨æ¥åˆå§‹åŒ–sqlè„šæœ¬ã€æ‰§è¡Œå»ºè¡¨è¯­å¥ç­‰ã€‚æœ‰ä¸¤ä¸ªç±»å¼ƒç”¨äº†ï¼Œä¹‹åå°±åªæœ‰6ä¸ªç±»ã€‚å¯ä»¥åˆ†ä¸ºsqlè¯­å¥ç”Ÿæˆï¼ˆAbstractSQLã€SQLï¼‰ã€è„šæœ¬æ‰§è¡Œï¼ˆScriptRunnerï¼‰ã€sqlæ‰§è¡Œï¼ˆSqlRunnerï¼‰ã€å…¶ä»–ï¼ˆRuntimeSqlExceptionã€Nullï¼‰</p><h4 id="_1-1-1-sqlè¯­å¥ç”Ÿæˆ" tabindex="-1"><a class="header-anchor" href="#_1-1-1-sqlè¯­å¥ç”Ÿæˆ" aria-hidden="true">#</a> 1.1.1 sqlè¯­å¥ç”Ÿæˆ</h4><p>ä¸»è¦æ˜¯æ‹¼æ¥sqlè¯­å¥(insertã€deletã€updateã€select)ã€‚æä¾›äº†ä¸€ä¸ªAbstractSQLæŠ½è±¡ç±»ï¼Œé‡Œé¢å…¨éƒ¨æ˜¯å¤§å†™çš„æ–¹æ³•ä¸ºäº†åœ¨è°ƒç”¨çš„æ—¶å€™çœ‹ç€åƒsqlè¯­å¥ä¸€æ ·ï¼Œåé¢å¦‚æœéœ€è¦æ‰©å±•sqlåŠŸèƒ½ä¹Ÿå¯ä»¥è‡ªå·±å®ç°AbstractSQLç±»ã€‚SQLç±»åªæ˜¯ç»§æ‰¿äº†AbstractSQLå¹¶è¿”å›äº†è‡ªå·±ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ä½¿ç”¨æ–¹å¼</span>
  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">void</span> <span class="token function">shouldDemonstrateFluentStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//Fluent Style</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">SELECT</span><span class="token punctuation">(</span><span class="token string">&quot;id, name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FROM</span><span class="token punctuation">(</span><span class="token string">&quot;PERSON A&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">WHERE</span><span class="token punctuation">(</span><span class="token string">&quot;name like ?&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">WHERE</span><span class="token punctuation">(</span><span class="token string">&quot;id = ?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;SELECT id, name\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;FROM PERSON A\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;WHERE (name like ? AND id = ?)&quot;</span><span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
<span class="token comment">// æ‹¼æ¥é€»è¾‘ å°†sqlæ‹¼æ¥ä¸ºä¸ºä¸€ä¸²sql</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">selectSQL</span><span class="token punctuation">(</span><span class="token class-name">SafeAppendable</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>distinct<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sqlClause</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> <span class="token string">&quot;SELECT DISTINCT&quot;</span><span class="token punctuation">,</span> select<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">sqlClause</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> <span class="token string">&quot;SELECT&quot;</span><span class="token punctuation">,</span> select<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">sqlClause</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> <span class="token string">&quot;FROM&quot;</span><span class="token punctuation">,</span> tables<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// joinå¤„ç†</span>
      <span class="token function">joins</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">sqlClause</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> <span class="token string">&quot;WHERE&quot;</span><span class="token punctuation">,</span> where<span class="token punctuation">,</span> <span class="token string">&quot;(&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; AND &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">sqlClause</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> <span class="token string">&quot;GROUP BY&quot;</span><span class="token punctuation">,</span> groupBy<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">sqlClause</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> <span class="token string">&quot;HAVING&quot;</span><span class="token punctuation">,</span> having<span class="token punctuation">,</span> <span class="token string">&quot;(&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; AND &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">sqlClause</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> <span class="token string">&quot;ORDER BY&quot;</span><span class="token punctuation">,</span> orderBy<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      limitingRowsStrategy<span class="token punctuation">.</span><span class="token function">appendClause</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-1-2-è„šæœ¬æ‰§è¡Œ" tabindex="-1"><a class="header-anchor" href="#_1-1-2-è„šæœ¬æ‰§è¡Œ" aria-hidden="true">#</a> 1.1.2 è„šæœ¬æ‰§è¡Œ</h4><p>è„šæœ¬æ‰§è¡ŒåŠŸèƒ½åªæœ‰ä¸€ä¸ªç±»ä¸»è¦æ˜¯ä¸ºäº†å»æ‰§è¡Œsqlè„šæœ¬æ–‡ä»¶ï¼Œæä¾›äº†å…¨æ–‡å’Œé€è¡Œæ‰§è¡Œä¸¤ç§æ–¹å¼</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ä½¿ç”¨æ–¹å¼</span>
  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">void</span> <span class="token function">shouldReturnWarningIfEndOfLineTerminatorNotFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ›å»ºéæ± åŒ–è¿æ¥</span>
    <span class="token class-name">DataSource</span> ds <span class="token operator">=</span> <span class="token function">createUnpooledDataSource</span><span class="token punctuation">(</span><span class="token constant">JPETSTORE_PROPERTIES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> resource <span class="token operator">=</span> <span class="token string">&quot;org/apache/ibatis/jdbc/ScriptMissingEOLTerminator.sql&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> conn <span class="token operator">=</span> ds<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">Reader</span> reader <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å°è£…æ•°æ®</span>
      <span class="token class-name">ScriptRunner</span> runner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScriptRunner</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      runner<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      runner<span class="token punctuation">.</span><span class="token function">setStopOnError</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      runner<span class="token punctuation">.</span><span class="token function">setErrorLogWriter</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      runner<span class="token punctuation">.</span><span class="token function">setLogWriter</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¿è¡Œè„šæœ¬</span>
        runner<span class="token punctuation">.</span><span class="token function">runScript</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;Expected script runner to fail due to missing end of line terminator.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assertTrue</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;end-of-line terminator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token comment">// è¿è¡Œè„šæœ¬éƒ¨åˆ†é€»è¾‘</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">runScript</span><span class="token punctuation">(</span><span class="token class-name">Reader</span> reader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sendFullScript<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å…¨æ–‡æ‰§è¡Œ</span>
        <span class="token function">executeFullScript</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// é€è¡Œæ‰§è¡Œ</span>
        <span class="token function">executeLineByLine</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token function">rollbackConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-1-3-sqlæ‰§è¡Œ" tabindex="-1"><a class="header-anchor" href="#_1-1-3-sqlæ‰§è¡Œ" aria-hidden="true">#</a> 1.1.3 sqlæ‰§è¡Œ</h4><p>sqlæ‰§è¡Œä¹Ÿåªæœ‰ä¸€ä¸ªç±»ï¼Œæä¾›äº†å¢åˆ æ”¹æŸ¥çš„æ–¹æ³•ï¼Œå¹¶ä¸”å°†å¤„ç†ç»“æœè¿›è¡Œäº†å¤„ç†</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ä½¿ç”¨æ–¹å¼</span>
  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">void</span> <span class="token function">shouldSelectOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ›å»ºæ•°æ®æº</span>
    <span class="token class-name">DataSource</span> ds <span class="token operator">=</span> <span class="token function">createUnpooledDataSource</span><span class="token punctuation">(</span><span class="token constant">JPETSTORE_PROPERTIES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ›å»ºæ•°æ®</span>
    <span class="token function">runScript</span><span class="token punctuation">(</span>ds<span class="token punctuation">,</span> <span class="token constant">JPETSTORE_DDL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">runScript</span><span class="token punctuation">(</span>ds<span class="token punctuation">,</span> <span class="token constant">JPETSTORE_DATA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> connection <span class="token operator">=</span> ds<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆ›å»ºsqlRunner</span>
      <span class="token class-name">SqlRunner</span> exec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlRunner</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// æ‰§è¡Œsqlè·å–ç»“æœ</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> row <span class="token operator">=</span> exec<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM PRODUCT WHERE PRODUCTID = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;FI-SW-01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;FI-SW-01&quot;</span><span class="token punctuation">,</span> row<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;PRODUCTID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token comment">// è°ƒç”¨é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸‹é¢æ˜¯ç»“æœå¤„ç†é€»è¾‘</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getResults</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿”å›åç§°çš„å­—æ®µååˆ—è¡¨</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> columns <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿”å›ç±»å‹çš„å¤„ç†å™¨åˆ—è¡¨</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeHandler</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> typeHandlers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–è¿”å›ç»“æœçš„è¡¨ã€å­—æ®µä¿¡æ¯</span>
    <span class="token class-name">ResultSetMetaData</span> rsmd <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> rsmd<span class="token punctuation">.</span><span class="token function">getColumnCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è®°å½•å­—æ®µå</span>
      columns<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rsmd<span class="token punctuation">.</span><span class="token function">getColumnLabel</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è®°å½•å­—æ®µçš„å¯¹åº”ç±»å‹å¤„ç†å™¨</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">classForName</span><span class="token punctuation">(</span>rsmd<span class="token punctuation">.</span><span class="token function">getColumnClassName</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TypeHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> typeHandler <span class="token operator">=</span> typeHandlerRegistry<span class="token punctuation">.</span><span class="token function">getTypeHandler</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>typeHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          typeHandler <span class="token operator">=</span> typeHandlerRegistry<span class="token punctuation">.</span><span class="token function">getTypeHandler</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        typeHandlers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>typeHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é»˜è®¤çš„ç±»å‹å¤„ç†å™¨æ˜¯objectå¤„ç†å™¨</span>
        typeHandlers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>typeHandlerRegistry<span class="token punctuation">.</span><span class="token function">getTypeHandler</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¾ªç¯å¤„ç†ç»“æœ</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> row <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> columns<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> columns<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TypeHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> handler <span class="token operator">=</span> typeHandlers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ”¾å…¥ç»“æœ</span>
        row<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token constant">ENGLISH</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handler<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-1-4-å…¶ä»–" tabindex="-1"><a class="header-anchor" href="#_1-1-4-å…¶ä»–" aria-hidden="true">#</a> 1.1.4 å…¶ä»–</h4><p>ä¹‹åå°±åªæœ‰Nullå’ŒRuntimeSqlExceptionä¸¤ä¸ªç±»ï¼ŒNullç±»æ˜¯ä¸ªæšä¸¾ç±»ä¸»è¦æ˜¯å‚æ•°å¤„ç†å™¨ç±»å‹å’Œjdbcç±»å‹çš„å…³è”ï¼ŒRuntimeSqlExceptionç»§æ‰¿äº†è¿è¡Œæ—¶å¼‚å¸¸</p><h3 id="_1-2-cacheåŒ…" tabindex="-1"><a class="header-anchor" href="#_1-2-cacheåŒ…" aria-hidden="true">#</a> 1.2 cacheåŒ…</h3><p>ç¼“å­˜åŒ…åˆ†ä¸ºç¼“å­˜keyå’Œç¼“å­˜å®ç°ï¼Œç¼“å­˜å®ç°çš„æ—¶å€™ä¸ºäº†èƒ½åŠ¨æ€ç»„åˆåˆ†ä¸ºæ ¸å¿ƒç¼“å­˜ï¼ˆæ°¸ä¹…ç¼“å­˜ã€æ—¥å¿—ç¼“å­˜ã€é˜»å¡ç¼“å­˜ã€åºåˆ—åŒ–ç¼“å­˜ã€åŒæ­¥ç¼“å­˜ã€äº‹åŠ¡ç¼“å­˜ï¼‰å’Œæ¸…ç†ç¼“å­˜ï¼ˆå…ˆè¿›å…ˆå‡ºã€è¿‘æœŸæœ€å°‘ä½¿ç”¨ã€å®šæ—¶æ¸…ç†ã€è½¯å¼•ç”¨æ¸…ç†ã€å¼±å¼•ç”¨æ¸…ç†ï¼‰ï¼Œä¹‹åç”¨è£…é¥°æ¨¡å¼å»ç»„è£…ç¼“å­˜ï¼Œæ¥å£å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>

  <span class="token comment">// è·å–æ ‡è¯†ç¬¦</span>
  <span class="token class-name">String</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// æ·»åŠ ç¼“å­˜</span>
  <span class="token keyword">void</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–ç¼“å­˜</span>
  <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// åˆ é™¤ç¼“å­˜</span>
  <span class="token class-name">Object</span> <span class="token function">removeObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// æ¸…ç†</span>
  <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–æ•°é‡</span>
  <span class="token keyword">int</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–è¯»å†™é”</span>
  <span class="token keyword">default</span> <span class="token class-name">ReadWriteLock</span> <span class="token function">getReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-1-ç¼“å­˜key" tabindex="-1"><a class="header-anchor" href="#_1-2-1-ç¼“å­˜key" aria-hidden="true">#</a> 1.2.1 ç¼“å­˜key</h4><p>ç¼“å­˜keyçš„ä½œç”¨æ˜¯ä¸ºäº†ä¿è¯ç¼“å­˜çš„keyæ— ç¢°æ’ã€æ¯”è¾ƒå’Œç”Ÿæˆçš„é€Ÿåº¦å¿«è®¾è®¡çš„ç±»ã€‚è¯¥ç±»åˆ©ç”¨äº†æ•°æ®åˆ—è¡¨ã€æ•°æ®åˆ—è¡¨ä¸ªæ•°ã€æ±‚å’Œæ ¡éªŒå€¼ã€hashcodeï¼Œåœ¨åˆ¤æ–­keyæ˜¯å¦ç›¸ç­‰æ—¶å…ˆé€šè¿‡åˆ¤æ–­hashcodeã€æ±‚å’Œæ ¡éªŒå€¼å’Œæ•°æ®åˆ—è¡¨æ€»æ•°ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªä¸æƒ³ç­‰åˆ™è¯´æ˜æ•°æ®ä¸ç­‰ï¼Œè¿™å‡ ä¸ªè®¡ç®—æ˜¯å¾ˆå¿«çš„ã€‚ä¹‹åå°±æ˜¯éå†æ•°æ®åˆ—è¡¨è¿›è¡Œå€¼çš„åˆ¤æ–­ï¼Œè¿™ä¸ªæ˜¯æœ€è€—æ—¶çš„åœ°æ–¹ï¼Œä½†æ˜¯ç¡®ä¿è¯äº†ä¸ä¼šå‡ºç°ç¢°æ’çš„é—®é¢˜ã€‚æºç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheKey</span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_MULTIPLIER</span> <span class="token operator">=</span> <span class="token number">37</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_HASHCODE</span> <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">;</span>
  <span class="token comment">// ä¹˜æ•°ç”¨æ¥è®¡ç®—hashcodeä½¿ç”¨</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> multiplier<span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœä¸¤ä¸ªç±»çš„hashcodeç›¸åŒï¼Œé‚£ä¹ˆä¸¤ä¸ªç±»çš„CacheKeyä¸€å®šä¸åŒ</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> hashcode<span class="token punctuation">;</span>
  <span class="token comment">// æ±‚å’Œæ ¡éªŒå€¼ï¼Œå¦‚æœä¸¤ä¸ªå¯¹è±¡çš„è¯¥å€¼ä¸åŒé‚£ä¹ˆä¸¤ä¸ªç±»çš„CacheKeyä¸€å®šä¸åŒ</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> checksum<span class="token punctuation">;</span>
  <span class="token comment">// æ›´æ–°æ¬¡æ•°</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>
  <span class="token comment">// æ›´æ–°æ•°æ®åˆ—è¡¨</span>
  <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> updateList<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">CacheKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hashcode <span class="token operator">=</span> <span class="token constant">DEFAULT_HASHCODE</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>multiplier <span class="token operator">=</span> <span class="token constant">DEFAULT_MULTIPLIER</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>updateList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æ›´æ–°ç¼“å­˜key</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> baseHashCode <span class="token operator">=</span> object <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token class-name">ArrayUtil</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>

    count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token comment">// checksum = checksum + åŸºç¡€hashcode</span>
    checksum <span class="token operator">+=</span> baseHashCode<span class="token punctuation">;</span>
    baseHashCode <span class="token operator">*=</span> count<span class="token punctuation">;</span>
    <span class="token comment">// hashcode = ä¹˜æ•° * hashcode + åŸºç¡€hashcode</span>
    hashcode <span class="token operator">=</span> multiplier <span class="token operator">*</span> hashcode <span class="token operator">+</span> baseHashCode<span class="token punctuation">;</span>

    updateList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// åˆ¤æ–­å¯¹è±¡æ˜¯å¦ç›¸ç­‰</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åœ°å€ä¸€æ ·åˆ™è‚¯å®šæ˜¯ä¸€ä¸ªå¯¹è±¡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœä¸æ˜¯cacheKeyå¯¹è±¡åˆ™è‚¯å®šä¸ç›¸ç­‰</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>object <span class="token keyword">instanceof</span> <span class="token class-name">CacheKey</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// hashcodeã€checksumã€countå…¶ä¸­ä»»ä½•ä¸€ä¸ªä¸ç›¸ç­‰åˆ™ä¸ç›¸ç­‰ã€‚å®ç°å¿«é€Ÿæ¯”è¾ƒ</span>
    <span class="token keyword">final</span> <span class="token class-name">CacheKey</span> cacheKey <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CacheKey</span><span class="token punctuation">)</span> object<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hashcode <span class="token operator">!=</span> cacheKey<span class="token punctuation">.</span>hashcode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>checksum <span class="token operator">!=</span> cacheKey<span class="token punctuation">.</span>checksum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">!=</span> cacheKey<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// éå†æ¯”è¾ƒæ›´æ–°æ•°æ®ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªä¸ç›¸ç­‰åˆ™ä¸ç­‰ã€‚ç¡®ä¿ä¸ä¼šå‘ç”Ÿç¢°æ’</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> updateList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Object</span> thisObject <span class="token operator">=</span> updateList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Object</span> thatObject <span class="token operator">=</span> cacheKey<span class="token punctuation">.</span>updateList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ArrayUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>thisObject<span class="token punctuation">,</span> thatObject<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">CacheKey</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CloneNotSupportedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">CacheKey</span> clonedCacheKey <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CacheKey</span><span class="token punctuation">)</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    clonedCacheKey<span class="token punctuation">.</span>updateList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>updateList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> clonedCacheKey<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-2-æ ¸å¿ƒç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#_1-2-2-æ ¸å¿ƒç¼“å­˜" aria-hidden="true">#</a> 1.2.2 æ ¸å¿ƒç¼“å­˜</h4><h5 id="_1-2-2-1-æ°¸ä¹…ç¼“å­˜perpetualcache" tabindex="-1"><a class="header-anchor" href="#_1-2-2-1-æ°¸ä¹…ç¼“å­˜perpetualcache" aria-hidden="true">#</a> 1.2.2.1 æ°¸ä¹…ç¼“å­˜PerpetualCache</h5><p>ä¸»è¦æœ‰ä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ªæ˜¯å”¯ä¸€æ ‡è¯†ä¸€ä¸ªæ˜¯ç”¨æ¥å­˜å‚¨æ•°æ®çš„mapã€‚é€»è¾‘ä¸å¤æ‚æºç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PerpetualCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>

  <span class="token comment">// æ ‡è¯†å”¯ä¸€ä¸€ä¸ªç¼“å­˜ï¼Œä¸€èˆ¬ç”¨å‘½åç©ºé—´</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>

  <span class="token comment">// å­˜å‚¨æ•°æ®</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-2-2-2-é˜»å¡ç¼“å­˜blockingcache" tabindex="-1"><a class="header-anchor" href="#_1-2-2-2-é˜»å¡ç¼“å­˜blockingcache" aria-hidden="true">#</a> 1.2.2.2 é˜»å¡ç¼“å­˜BlockingCache</h5><p>ä¸»è¦æ˜¯ä¸ºäº†å®ç°ä¸€ä¸ªçº¿ç¨‹åœ¨è¯·æ±‚æ•°æ®åº“çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¹Ÿç”¨åŒæ ·çš„å‚æ•°å»è¯·æ±‚ã€‚è¿™ä¸ªæ—¶å€™åé¢çš„çº¿ç¨‹åº”è¯¥ç­‰å¾…ç¬¬ä¸€ä¸ªçº¿ç¨‹æŸ¥è¯¢å®Œæˆä¹‹åè·å–ç¬¬ä¸€ä¸ªçº¿ç¨‹çš„æŸ¥è¯¢ç»“æœã€‚3.5.7ç‰ˆæœ¬æ˜¯ç”¨çš„CountDownLatchå®ç°çš„é”ç­‰å¾…åŠŸèƒ½ï¼Œä¹‹å‰çš„çš„ç‰ˆæœ¬æ˜¯ç”¨çš„ReentrantLockå®ç°çš„ã€‚å…·ä½“æºç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// é˜»å¡ç¼“å­˜ï¼šå®ç°å¦‚æœç¬¬ä¸€ä¸ªè¯·æ±‚æ•°æ®åº“è¿˜æ²¡æœ‰å¾—åˆ°æ•°æ®ï¼Œç¬¬äºŒä¸ªè¯·æ±‚æ˜¯ç›¸åŒçš„æƒ…å†µæ•°æ®</span>
<span class="token comment">// é‚£ä¹ˆç¬¬äºŒä¸ªè¯·æ±‚å°±é˜»å¡ç­‰å¾…ç¬¬ä¸€ä¸ªæŸ¥è¯¢åˆ°æ•°æ®åç›´æ¥è¿”å›ç»™ç¬¬äºŒä¸ªè¯·æ±‚</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BlockingCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>
  <span class="token comment">// é”ç­‰å¾…æ—¶é—´</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> timeout<span class="token punctuation">;</span>
  <span class="token comment">// è¢«è£…é¥°å¯¹è±¡</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Cache</span> delegate<span class="token punctuation">;</span>
  <span class="token comment">// é”çš„æ˜ å°„è¡¨ï¼Œé”®ä¸ºç¼“å­˜çš„keyï¼Œå€¼ä¸ºé”</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">&gt;</span></span> locks<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// å‘ç¼“å­˜ä¸­æ”¾å…¥æ•°æ®</span>
      delegate<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token comment">// é‡Šæ”¾é”</span>
      <span class="token function">releaseLock</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–é”</span>
    <span class="token function">acquireLock</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¯»å–ç»“æœ</span>
    <span class="token class-name">Object</span> value <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç»“æœä¸ºnullé‡Šæ”¾é”</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">releaseLock</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœæ²¡æœ‰è¯»åˆ°å€¼ï¼Œåˆ™ä¸ä¼šé‡Šæ”¾é”ã€‚ç­‰åˆ°è¯»åˆ°æ•°æ®åº“æ•°æ®ä¹‹åè°ƒç”¨putæ–¹æ³•åé‡Šæ”¾é”</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// è·å–æŸä¸ªé”®çš„é”</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">acquireLock</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// CountDownLatchèƒ½å¤Ÿä½¿ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…å¦å¤–ä¸€äº›çº¿ç¨‹å®Œæˆå„è‡ªå·¥ä½œä¹‹åï¼Œå†ç»§ç»­æ‰§è¡Œ</span>
    <span class="token class-name">CountDownLatch</span> newLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœä¼ å…¥keyå¯¹åº”çš„valueå·²ç»å­˜åœ¨ï¼Œå°±è¿”å›å­˜åœ¨çš„valueï¼Œä¸è¿›è¡Œæ›¿æ¢ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œå°±æ·»åŠ keyå’Œvalueï¼Œè¿”å›null</span>
      <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> locks<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> newLatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>latch <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// ä½¿å½“å‰çº¿ç¨‹åœ¨é”å­˜å™¨å€’è®¡æ•°è‡³é›¶ä¹‹å‰ä¸€ç›´ç­‰å¾…ï¼Œé™¤éçº¿ç¨‹è¢«ä¸­æ–­æˆ–è¶…å‡ºäº†æŒ‡å®šçš„ç­‰å¾…æ—¶é—´ã€‚å¦‚æœå½“å‰è®¡æ•°ä¸ºé›¶ï¼Œåˆ™æ­¤æ–¹æ³•ç«‹åˆ»è¿”å›trueå€¼</span>
          <span class="token keyword">boolean</span> acquired <span class="token operator">=</span> latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>acquired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Couldn&#39;t get a lock in &quot;</span> <span class="token operator">+</span> timeout <span class="token operator">+</span> <span class="token string">&quot; for the key &quot;</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">&quot; at the cache &quot;</span> <span class="token operator">+</span> delegate<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°è®¡æ•°å™¨çš„å€¼ä¸º0</span>
          latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheException</span><span class="token punctuation">(</span><span class="token string">&quot;Got interrupted while trying to acquire lock for key &quot;</span> <span class="token operator">+</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// é‡Šæ”¾é”</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">releaseLock</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> locks<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>latch <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Detected an attempt at releasing unacquired lock. This should never happen.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// é€’å‡é”å­˜å™¨çš„è®¡æ•°ï¼Œå¦‚æœè®¡æ•°åˆ°è¾¾é›¶ï¼Œåˆ™é‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹</span>
    latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-2-2-3-æ—¥å¿—ç¼“å­˜loggingcache" tabindex="-1"><a class="header-anchor" href="#_1-2-2-3-æ—¥å¿—ç¼“å­˜loggingcache" aria-hidden="true">#</a> 1.2.2.3 æ—¥å¿—ç¼“å­˜LoggingCache</h5><p>ä¸»è¦æ˜¯ä¸ºäº†è®°å½•ç¼“å­˜çš„å‘½ä¸­æ¬¡æ•°å’Œè¯·æ±‚æ¬¡æ•°</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// è®°å½•ç¼“å­˜çš„å‘½ä¸­æ¬¡æ•°å’Œè¯·æ±‚æ¬¡æ•°</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoggingCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> log<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Cache</span> delegate<span class="token punctuation">;</span>
  <span class="token comment">// è¯·æ±‚æ¬¡æ•°</span>
  <span class="token keyword">protected</span> <span class="token keyword">int</span> requests <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token keyword">int</span> hits <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">LoggingCache</span><span class="token punctuation">(</span><span class="token class-name">Cache</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> delegate<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>log <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> delegate<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> delegate<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    delegate<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    requests<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span> value <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hits<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Cache Hit Ratio [&quot;</span> <span class="token operator">+</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]: &quot;</span> <span class="token operator">+</span> <span class="token function">getHitRatio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-2-2-4-å®šæ—¶ç¼“å­˜scheduledcache" tabindex="-1"><a class="header-anchor" href="#_1-2-2-4-å®šæ—¶ç¼“å­˜scheduledcache" aria-hidden="true">#</a> 1.2.2.4 å®šæ—¶ç¼“å­˜ScheduledCache</h5><p>ä¸»è¦æ˜¯é€šè¿‡è®¾ç½®æ—¶é—´é—´éš”ä¹‹åé€šè¿‡é—´éš”æ—¶é—´æ¸…ç†ç¼“å­˜ï¼Œåœ¨get/putæ—¶è¿›è¡Œæ¸…ç†æ“ä½œã€‚æ¸…ç†é€»è¾‘ä¸æ˜¯å®šæ—¶å»æ¸…ç†ï¼Œè€Œæ˜¯é€šè¿‡get/putæ—¶å»åˆ¤æ–­æ¸…ç†è¿™æ ·å‡å°‘äº†ä¸€ä¸ªæ¸…ç†çš„å®šæ—¶ä»»åŠ¡ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>

  <span class="token comment">// è¢«è£…é¥°ç¼“å­˜</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Cache</span> delegate<span class="token punctuation">;</span>
  <span class="token comment">// æ¸…ç†çš„æ—¶é—´é—´éš”</span>
  <span class="token keyword">protected</span> <span class="token keyword">long</span> clearInterval<span class="token punctuation">;</span>
  <span class="token comment">// ä¸Šæ¬¡æ¸…ç†æ—¶åˆ»</span>
  <span class="token keyword">protected</span> <span class="token keyword">long</span> lastClear<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">ScheduledCache</span><span class="token punctuation">(</span><span class="token class-name">Cache</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> delegate<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clearInterval <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lastClear <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">removeObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// éå®æ—¶çš„å»è¿›è¡Œè°ƒç”¨æ¸…ç†</span>
    <span class="token function">clearWhenStale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> delegate<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æ ¹æ®æ—¶é—´é—´éš”è®¾ç½®ç¼“å­˜æ¸…ç†ï¼ˆç¬¬ä¸€æ¬¡ç¼“å­˜ä¸Šåï¼Œåªèƒ½ç¬¬äºŒæ¬¡è°ƒç”¨çš„æ—¶å€™å¦‚æœæ—¶é—´è¶…å‡ºç±»æ—¶é—´é—´éš”æ‰ä¼šclearï¼‰</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">clearWhenStale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> lastClear <span class="token operator">&gt;</span> clearInterval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-2-2-5-åºåˆ—åŒ–ç¼“å­˜serializedcache" tabindex="-1"><a class="header-anchor" href="#_1-2-2-5-åºåˆ—åŒ–ç¼“å­˜serializedcache" aria-hidden="true">#</a> 1.2.2.5 åºåˆ—åŒ–ç¼“å­˜SerializedCache</h5><p>ä¸»è¦æ˜¯å¯¹æ•°æ®è¿›è¡Œåºåˆ—åŒ–å­˜å‚¨å’Œååºåˆ—åŒ–ï¼Œä¸ºäº†å®ç°æ¯æ¬¡è¯»å–çš„éƒ½æ˜¯ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡è€Œä¸æ˜¯ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ã€‚å¦‚æœæ˜¯å¯¹è±¡çš„å¼•ç”¨å¯èƒ½è°ƒç”¨æ–¹åœ¨è·å–å¯¹è±¡åè¿›è¡Œå¯¹è±¡çš„æ“ä½œå°±ä¼šä¿®æ”¹å¯¹è±¡é‡Œé¢çš„å€¼ï¼Œè€Œæˆ‘ä»¬å¸Œæœ›ç¼“å­˜é‡Œé¢çš„æ•°æ®ä¸å˜ã€‚è¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨SerializedCacheï¼Œæ–°çš„å¯¹è±¡ä¸å½±å“ç¼“å­˜ä¸­çš„å¯¹è±¡ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SerializedCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Cache</span> delegate<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">SerializedCache</span><span class="token punctuation">(</span><span class="token class-name">Cache</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> delegate<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ•°æ®å¿…é¡»å¯åºåˆ—åŒ–</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> object <span class="token keyword">instanceof</span> <span class="token class-name">Serializable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ•°æ®åºåˆ—åŒ–åå­˜å‚¨ç¼“å­˜</span>
      delegate<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Serializable</span><span class="token punctuation">)</span> object<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheException</span><span class="token punctuation">(</span><span class="token string">&quot;SharedCache failed to make a copy of a non-serializable object: &quot;</span> <span class="token operator">+</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> object <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ•°æ®ååºåˆ—åŒ–</span>
    <span class="token keyword">return</span> object <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// åºåˆ—åŒ–</span>
  <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">Serializable</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ByteArrayOutputStream</span> bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>bos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      oos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> bos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheException</span><span class="token punctuation">(</span><span class="token string">&quot;Error serializing object.  Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ååºåˆ—åŒ–</span>
  <span class="token keyword">private</span> <span class="token class-name">Serializable</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SerialFilterChecker</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Serializable</span> result<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ByteArrayInputStream</span> bis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomObjectInputStream</span><span class="token punctuation">(</span>bis<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Serializable</span><span class="token punctuation">)</span> ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheException</span><span class="token punctuation">(</span><span class="token string">&quot;Error deserializing object.  Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CustomObjectInputStream</span> <span class="token keyword">extends</span> <span class="token class-name">ObjectInputStream</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">CustomObjectInputStream</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token class-name">ObjectStreamClass</span> desc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">classForName</span><span class="token punctuation">(</span>desc<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-2-2-6-åŒæ­¥ç¼“å­˜synchronizedcache" tabindex="-1"><a class="header-anchor" href="#_1-2-2-6-åŒæ­¥ç¼“å­˜synchronizedcache" aria-hidden="true">#</a> 1.2.2.6 åŒæ­¥ç¼“å­˜SynchronizedCache</h5><p>è¿™ä¸ªç¼“å­˜å°±æ˜¯åœ¨getSizeã€putObjectã€getObjectã€removeObjectã€clearæ–¹æ³•ä¸Šé¢æ·»åŠ äº†synchronizedåè°ƒç”¨è¢«è£…é¥°å¯¹è±¡</p><h5 id="_1-2-2-7-äº‹åŠ¡ç¼“å­˜transactionalcache" tabindex="-1"><a class="header-anchor" href="#_1-2-2-7-äº‹åŠ¡ç¼“å­˜transactionalcache" aria-hidden="true">#</a> 1.2.2.7 äº‹åŠ¡ç¼“å­˜TransactionalCache</h5><p>äº‹åŠ¡ç¼“å­˜æä¾›äº†äº‹åŠ¡æäº¤æ—¶å­˜å…¥ç¼“å­˜ï¼Œäº‹åŠ¡å›æ»šæ—¶é”€æ¯ç¼“å­˜çš„åŠŸèƒ½ã€‚ä¹‹åè¿˜æä¾›äº†ä¸€ä¸ªäº‹åŠ¡ç¼“å­˜ç®¡ç†å™¨ç”¨æ¥ç®¡ç†äº‹åŠ¡ç¼“å­˜è¿›è¡Œå¤šä¸ªäº‹åŠ¡çš„å­˜å…¥æˆ–é”€æ¯æ“ä½œã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// æä¾›äº†äº‹åŠ¡æäº¤æ—¶å­˜å…¥ç¼“å­˜ï¼Œäº‹åŠ¡å›æ»šæ—¶é”€æ¯ç¼“å­˜çš„åŠŸèƒ½</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionalCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> log <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">TransactionalCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è¢«è£…é¥°çš„å¯¹è±¡</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Cache</span> delegate<span class="token punctuation">;</span>
  <span class="token comment">// äº‹åŠ¡æäº¤åæ˜¯å¦ç›´æ¥æ¸…ç†ç¼“å­˜</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> clearOnCommit<span class="token punctuation">;</span>
  <span class="token comment">// äº‹åŠ¡æäº¤æ—¶å€™éœ€è¦å†™å…¥ç¼“å­˜çš„æ•°æ®</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entriesToAddOnCommit<span class="token punctuation">;</span>
  <span class="token comment">// ç¼“å­˜æŸ¥è¯¢æœªå‘½ä¸­çš„æ•°æ®ï¼ˆä¸ºä»€ä¹ˆè¦ä¿å­˜æœªå‘½ä¸­çš„æ•°æ®ï¼šç¼“å­˜å¯èƒ½è¢«blockingCacheè£…é¥°è¿‡ï¼Œ</span>
  <span class="token comment">// å¦‚æœæ•°æ®çš„ç»“æœæŸ¥è¯¢ä¸ºç©ºï¼Œåˆ™ä¼šå¯¹æ•°æ®è¿›è¡Œä¸Šé”ä»è€Œé˜»å¡åé¢çš„æŸ¥è¯¢ï¼Œè¿™ä¸ªæ•°æ®å°±æ˜¯ä¸ºäº†åæœŸè§£é”ç”¨çš„ï¼‰</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entriesMissedInCache<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">TransactionalCache</span><span class="token punctuation">(</span><span class="token class-name">Cache</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> delegate<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clearOnCommit <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>entriesToAddOnCommit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>entriesMissedInCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// issue #116 ä»ç¼“å­˜ä¸­è¯»å–æ•°æ®</span>
    <span class="token class-name">Object</span> object <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æœªå‘½ä¸­ç¼“å­˜è®°å½•åˆ°setä¸­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      entriesMissedInCache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// issue #146 å¦‚æœè®¾ç½®äº†æäº¤æ—¶ç«‹å³æ¸…ç†åˆ™è¿”å›ç©º</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clearOnCommit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿”å›æŸ¥è¯¢ç»“æœ</span>
      <span class="token keyword">return</span> object<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å…ˆå°†æ•°æ®æ”¾åˆ° éœ€è¦å†™å…¥ç¼“å­˜ çš„åˆ—è¡¨ä¸­</span>
    entriesToAddOnCommit<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ˜¯ç›´æ¥æ¸…ç†ç¼“å­˜ï¼Œåˆ™ç›´æ¥æ¸…ç†ç¼“å­˜</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clearOnCommit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      delegate<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å°†æœªå†™å…¥ç¼“å­˜çš„æ•°æ®å†™å…¥ç¼“å­˜</span>
    <span class="token function">flushPendingEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¸…ç†ç¯å¢ƒ</span>
    <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ é™¤ç¼“å­˜æœªå‘½ä¸­çš„æ•°æ®</span>
    <span class="token function">unlockMissedEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¸…ç†æ•°æ®</span>
    <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æ¸…ç†ç¯å¢ƒ</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clearOnCommit <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    entriesToAddOnCommit<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    entriesMissedInCache<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// åˆ·æ–°åˆ°ç¼“å­˜é‡Œé¢å°†æœªå†™å…¥ç¼“å­˜çš„æ•°æ®</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">flushPendingEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†entriesToAddOnCommité‡Œé¢çš„æ•°æ®å†™å…¥ç¼“å­˜</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> entriesToAddOnCommit<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      delegate<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å°†entriesMissedInCacheé‡Œé¢çš„æ•°æ®å†™å…¥ç¼“å­˜</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> entry <span class="token operator">:</span> entriesMissedInCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entriesToAddOnCommit<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        delegate<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// åˆ é™¤æœªå‘½ä¸­çš„æ•°æ®</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unlockMissedEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> entry <span class="token operator">:</span> entriesMissedInCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        delegate<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected exception while notifying a rollback to the cache adapter. &quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;Consider upgrading your cache adapter to the latest version. Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>äº‹åŠ¡ç®¡ç†å™¨</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ç”¨æ¥ç®¡ç†ä¸€ä¸ªäº‹åŠ¡ä¸­çš„å¤šä¸ªç¼“å­˜</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionalCacheManager</span> <span class="token punctuation">{</span>

  <span class="token comment">// ç®¡ç†å¤šä¸ªç¼“å­˜çš„æ˜ å°„</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Cache</span><span class="token punctuation">,</span> <span class="token class-name">TransactionalCache</span><span class="token punctuation">&gt;</span></span> transactionalCaches <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// äº‹åŠ¡æäº¤</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TransactionalCache</span> txCache <span class="token operator">:</span> transactionalCaches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      txCache<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// äº‹åŠ¡å›æ»š</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TransactionalCache</span> txCache <span class="token operator">:</span> transactionalCaches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      txCache<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">TransactionalCache</span> <span class="token function">getTransactionalCache</span><span class="token punctuation">(</span><span class="token class-name">Cache</span> cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>transactionalCaches<span class="token punctuation">,</span> cache<span class="token punctuation">,</span> <span class="token class-name">TransactionalCache</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-3-æ¸…ç†ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#_1-2-3-æ¸…ç†ç¼“å­˜" aria-hidden="true">#</a> 1.2.3 æ¸…ç†ç¼“å­˜</h4><h5 id="_1-2-3-1-å…ˆè¿›å…ˆå‡ºfifocache" tabindex="-1"><a class="header-anchor" href="#_1-2-3-1-å…ˆè¿›å…ˆå‡ºfifocache" aria-hidden="true">#</a> 1.2.3.1 å…ˆè¿›å…ˆå‡ºFifoCache</h5><p>é€šè¿‡æ·»åŠ ä¸€ä¸ªç¼“å­˜æ•°é‡å’Œç¼“å­˜é˜Ÿåˆ—çš„å­—æ®µå»å®ç°å…ˆè¿›å…ˆå‡ºçš„åŠŸèƒ½ï¼Œå¦‚æœç¼“å­˜æ•°é‡è¶…è¿‡äº†ç¼“å­˜çš„æ•°é‡å°±å°†æœ€å…ˆè¿›å…¥çš„ç¼“å­˜åˆ é™¤æ‰</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å…ˆè¿›å…ˆå‡ºç­–ç•¥æ¸…ç†</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FifoCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>

  <span class="token comment">// è¢«è£…é¥°å¯¹è±¡</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Cache</span> delegate<span class="token punctuation">;</span>
  <span class="token comment">// é˜Ÿåˆ—ä¿å­˜ç¼“å­˜key</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> keyList<span class="token punctuation">;</span>
  <span class="token comment">// ç¼“å­˜ç©ºé—´å¤§å†™</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">FifoCache</span><span class="token punctuation">(</span><span class="token class-name">Cache</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> delegate<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>keyList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cycleKeyList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    delegate<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cycleKeyList</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    keyList<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœè¶…è¿‡ç¼“å­˜æ•°é‡åˆ™åˆ é™¤ç¼“å­˜</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>keyList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Object</span> oldestKey <span class="token operator">=</span> keyList<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      delegate<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>oldestKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-2-3-2-è¿‘æœŸæœ€å°‘ä½¿ç”¨lrucache" tabindex="-1"><a class="header-anchor" href="#_1-2-3-2-è¿‘æœŸæœ€å°‘ä½¿ç”¨lrucache" aria-hidden="true">#</a> 1.2.3.2 è¿‘æœŸæœ€å°‘ä½¿ç”¨LruCache</h5><p>è¿‘æœŸæœ€å°‘ä½¿ç”¨åŠŸèƒ½ä¸»è¦æ˜¯åˆ©ç”¨çš„LinkedHashMapçš„è®°å½•é¡ºåºç‰¹æ€§å®ç°çš„åŠŸèƒ½ï¼Œè®°å½•äº†è°ƒç”¨getæ–¹æ³•çš„æ¬¡æ•°ã€‚ç„¶ååˆ é™¤æœ€å°‘ä½¿ç”¨çš„ç¼“å­˜</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// è¿‘æœŸæœ€å°‘ä½¿ç”¨æ¸…ç†</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LruCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Cache</span> delegate<span class="token punctuation">;</span>
  <span class="token comment">// ä¿å­˜çš„ç¼“å­˜æ•°æ®çš„é”®</span>
  <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> keyMap<span class="token punctuation">;</span>
  <span class="token comment">// æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„é”®</span>
  <span class="token keyword">private</span> <span class="token class-name">Object</span> eldestKey<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">LruCache</span><span class="token punctuation">(</span><span class="token class-name">Cache</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> delegate<span class="token punctuation">;</span>
    <span class="token function">setSize</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSize</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ³¨æ„LinkedHashMapçš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œtrueè¡¨ç¤ºè¯¥LinkedHashMapè®°å½•çš„é¡ºåºaccess-order</span>
    <span class="token comment">// ä¹Ÿå°±æ˜¯è¯´è°ƒç”¨LinkedHashMapçš„getæ–¹æ³•ä¼šæ”¹å˜å…¶è®°å½•çš„é¡ºåº</span>
    keyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">.75F</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">4267176411845948333L</span><span class="token punctuation">;</span>

      <span class="token doc-comment comment">/**
       * æ¯æ¬¡LinkedHashMapæ”¾å…¥æ•°æ®æ—¶è§¦å‘
       * <span class="token keyword">@param</span> <span class="token parameter">eldest</span> æœ€ä¹…æ²¡æœ‰è¢«ä½¿ç”¨çš„æ•°æ®
       * <span class="token keyword">@return</span> æœ€ä¹…æ²¡æœ‰è¢«ä½¿ç”¨çš„æ•°æ®æ˜¯å¦åº”è¯¥è¢«åˆ é™¤
       */</span>
      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">removeEldestEntry</span><span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> eldest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> tooBig <span class="token operator">=</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> size<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tooBig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// è®¾ç½®æœ€å°‘ä½¿ç”¨çš„key</span>
          eldestKey <span class="token operator">=</span> eldest<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> tooBig<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    delegate<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘keyMapä¸­å­˜æ”¾keyï¼Œå¹¶åˆ é™¤ä½¿ç”¨æœ€ä¹…çš„key</span>
    <span class="token function">cycleKeyList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è§¦å‘ä¸€ä¸‹å½“å‰è¢«è®¿é—®çš„é”®</span>
    keyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// touch</span>
    <span class="token keyword">return</span> delegate<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cycleKeyList</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    keyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœæœ€å°‘ä½¿ç”¨çš„é”®ä¸ä¸ºç©ºåˆ™ç›´æ¥åˆ é™¤</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eldestKey <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      delegate<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>eldestKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      eldestKey <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-3-3-3-å¼±å¼•ç”¨weakcache" tabindex="-1"><a class="header-anchor" href="#_1-3-3-3-å¼±å¼•ç”¨weakcache" aria-hidden="true">#</a> 1.3.3.3 å¼±å¼•ç”¨WeakCache</h5><p>ä¸»è¦æ˜¯åˆ©ç”¨çš„jvmçš„å¼±å¼•ç”¨æ¸…ç†å®ç°çš„ï¼Œåœ¨jvmæ¸…ç†ç¼“å­˜ä¹‹åå»åˆ é™¤å¯¹åº”çš„ç¼“å­˜key</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å°†ç¼“å­˜åŒ…è£…ä¸ºå¼±å¼•ç”¨ï¼Œä¾¿äºjvmæ¸…ç†</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeakCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¼ºå¼•ç”¨å¯¹è±¡åˆ—è¡¨</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> hardLinksToAvoidGarbageCollection<span class="token punctuation">;</span>
  <span class="token comment">// å¼±å¼•ç”¨å¯¹è±¡åˆ—è¡¨</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> queueOfGarbageCollectedEntries<span class="token punctuation">;</span>
  <span class="token comment">// è¢«è£…é¥°å¯¹è±¡</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Cache</span> delegate<span class="token punctuation">;</span>
  <span class="token comment">// å¼ºå¼•ç”¨å¯¹è±¡çš„é™åˆ¶</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> numberOfHardLinks<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">WeakCache</span><span class="token punctuation">(</span><span class="token class-name">Cache</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> delegate<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>numberOfHardLinks <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hardLinksToAvoidGarbageCollection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queueOfGarbageCollectedEntries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ é™¤åƒåœ¾å›æ”¶é˜Ÿåˆ—ä¸­çš„å…ƒç´ </span>
    <span class="token function">removeGarbageCollectedItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å°†å¼±å¼•ç”¨putåˆ°è¢«è£…é¥°å¯¹è±¡ä¸­</span>
    delegate<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WeakEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> queueOfGarbageCollectedEntries<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span> <span class="token comment">// assumed delegate cache is totally managed by this cache</span>
    <span class="token comment">// ä»ç¼“å­˜ä¸­æŸ¥æ‰¾å¯¹åº”çš„ç¼“å­˜é¡¹</span>
    <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> weakReference <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> delegate<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å­˜åœ¨ç¼“å­˜é¡¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>weakReference <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> weakReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// å·²ç»è¢«gcå›æ”¶</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¸…æ¥šå¯¹åº”ç¼“å­˜é¡¹</span>
        delegate<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>hardLinksToAvoidGarbageCollection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// å°†valueæ·»åŠ åˆ°hardLinksToAvoidGarbageCollectionä¿ç•™</span>
          hardLinksToAvoidGarbageCollection<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// å¦‚æœhardLinksToAvoidGarbageCollectionçš„æ•°é‡è¶…è¿‡å¼ºå¼•ç”¨å¯¹è±¡çš„é™åˆ¶</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>hardLinksToAvoidGarbageCollection<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> numberOfHardLinks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ç›´æ¥åˆ é™¤</span>
            hardLinksToAvoidGarbageCollection<span class="token punctuation">.</span><span class="token function">removeLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>hardLinksToAvoidGarbageCollection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hardLinksToAvoidGarbageCollection<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">removeGarbageCollectedItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    delegate<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å°†å·²ç»è¢«åƒåœ¾å›æ”¶æ‰çš„å¯¹è±¡æ¸…ç†æ‰</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">removeGarbageCollectedItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">WeakEntry</span> sv<span class="token punctuation">;</span>
    <span class="token comment">// å–å‡ºçš„æ˜¯è½¯å¼•ç”¨çš„åŒ…è£…ç±»ï¼Œéå†é›†åˆï¼Œæ¸…æ¥šè¢«gcè¿‡çš„key</span>
    <span class="token comment">// ReferenceQueue.pollæ–¹æ³•éå†é˜Ÿåˆ—ï¼Œå¦‚æœå¼•ç”¨ä¸å¯ä»¥åˆ™è·å–å¯¹è±¡å¹¶è¿”å›ï¼Œå¦åˆ™è¿”å›null</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sv <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WeakEntry</span><span class="token punctuation">)</span> queueOfGarbageCollectedEntries<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      delegate<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>sv<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WeakEntry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™ä¸ªå±æ€§ä¸ä¼šè¢«æ¸…ç†æ‰ï¼Œå­˜å‚¨ç›®æ ‡å¯¹è±¡çš„key</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> key<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">WeakEntry</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> garbageCollectionQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> garbageCollectionQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-3-3-4-è½¯å¼•ç”¨softcache" tabindex="-1"><a class="header-anchor" href="#_1-3-3-4-è½¯å¼•ç”¨softcache" aria-hidden="true">#</a> 1.3.3.4 è½¯å¼•ç”¨SoftCache</h5><p>è½¯å¼•ç”¨é€»è¾‘å’Œå¼±å¼•ç”¨é€»è¾‘ä¸€è‡´</p><h4 id="_1-3-4-ç¼“å­˜çš„ç»„å»º" tabindex="-1"><a class="header-anchor" href="#_1-3-4-ç¼“å­˜çš„ç»„å»º" aria-hidden="true">#</a> 1.3.4 ç¼“å­˜çš„ç»„å»º</h4><p>ç¼“å­˜çš„ç»„å»ºå°±æ˜¯æ·»åŠ è£…é¥°çš„è¿‡ç¨‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// é€šè¿‡mapper.xmlé‡Œé¢çš„ç¼“å­˜é…ç½®å»è£…é¥°</span>
<span class="token operator">&lt;</span>cache type<span class="token operator">=</span><span class="token string">&quot;PERPETUAL&quot;</span> eviction<span class="token operator">=</span><span class="token string">&quot;FIFO&quot;</span> flushInterval<span class="token operator">=</span><span class="token string">&quot;6000&quot;</span> size<span class="token operator">=</span><span class="token string">&quot;512&quot;</span> readOnly<span class="token operator">=</span><span class="token string">&quot;true&quot;</span> blocking<span class="token operator">=</span><span class="token string">&quot;true&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>

	<span class="token keyword">public</span> <span class="token class-name">Cache</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®¾ç½®ç¼“å­˜çš„é»˜è®¤å®ç°</span>
    <span class="token function">setDefaultImplementations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ›å»ºé»˜è®¤çš„ç¼“å­˜</span>
    <span class="token class-name">Cache</span> cache <span class="token operator">=</span> <span class="token function">newBaseCacheInstance</span><span class="token punctuation">(</span>implementation<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCacheProperties</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// issue #352, do not apply decorators to custom caches</span>
    <span class="token comment">// ç¼“å­˜å®ç°ç±»æ˜¯PerpetualCache</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PerpetualCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// éå†è£…é¥°å™¨ï¼Œé€çº§åµŒå¥—è‡ªå®šä¹‰è£…é¥°å™¨</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Cache</span><span class="token punctuation">&gt;</span></span> decorator <span class="token operator">:</span> decorators<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cache <span class="token operator">=</span> <span class="token function">newCacheDecoratorInstance</span><span class="token punctuation">(</span>decorator<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setCacheProperties</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ·»åŠ æ ‡å‡†è£…é¥°å™¨</span>
      cache <span class="token operator">=</span> <span class="token function">setStandardDecorators</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ—¥å¿—ç¼“å­˜å¤„ç†</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">LoggingCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ·»åŠ æ—¥å¿—è£…é¥°å™¨</span>
      cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggingCache</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cache<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// ä¸ºç¼“å­˜æ·»åŠ æ ‡å‡†çš„è£…é¥°å™¨</span>
  <span class="token keyword">private</span> <span class="token class-name">Cache</span> <span class="token function">setStandardDecorators</span><span class="token punctuation">(</span><span class="token class-name">Cache</span> cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// è®¾ç½®ç¼“å­˜å¤§å°</span>
      <span class="token class-name">MetaObject</span> metaCache <span class="token operator">=</span> <span class="token class-name">SystemMetaObject</span><span class="token punctuation">.</span><span class="token function">forObject</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> metaCache<span class="token punctuation">.</span><span class="token function">hasSetter</span><span class="token punctuation">(</span><span class="token string">&quot;size&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        metaCache<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">&quot;size&quot;</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// å®šä¹‰äº†æ¸…ç†é—´éš”åˆ™æ·»åŠ æ¸…ç†è£…é¥°å™¨</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>clearInterval <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduledCache</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ScheduledCache</span><span class="token punctuation">)</span> cache<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setClearInterval</span><span class="token punctuation">(</span>clearInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// å¦‚æœå…è®¸è¯»å†™åˆ™æ·»åŠ åºåˆ—åŒ–è£…é¥°å™¨</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>readWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SerializedCache</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ·»åŠ æ—¥å¿—å’ŒåŒæ­¥è£…é¥°å™¨</span>
      cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggingCache</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedCache</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// å¼€å¯äº†é˜»å¡åŠŸèƒ½åˆ™æ·»åŠ é˜»å¡è£…é¥°å™¨</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>blocking<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlockingCache</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> cache<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheException</span><span class="token punctuation">(</span><span class="token string">&quot;Error building standard cache decorators.  Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>mybatisæä¾›ä¸€çº§å’ŒäºŒçº§ç¼“å­˜ï¼Œåœ¨è·å–ç¼“å­˜æ•°æ®çš„æ—¶å€™æ˜¯å…ˆå»è·å–äºŒçº§ç¼“å­˜çš„æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è·å–ä¸€çº§ç¼“å­˜çš„æ•°æ®ã€‚ä¸€çº§ç¼“å­˜æ˜¯é»˜è®¤å¼€å¯çš„ï¼ŒäºŒçº§ç¼“å­˜æœ‰4ä¸ªåœ°æ–¹éœ€è¦é…ç½®ã€‚åœ¨é…ç½®ä¹‹åç¼“å­˜ç®¡ç†å™¨ï¼ˆCachingExecutorï¼‰é‡Œé¢å°±ä¼šå»å¤„ç†ç¼“å­˜é€»è¾‘</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>  <span class="token comment">&lt;!--
  äºŒçº§ç¼“å­˜çš„ç›¸å…³é…ç½®æœ‰å››é¡¹ï¼š
  1. &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt; é»˜è®¤å°±æ˜¯true
  2. &lt;cache/&gt;å’Œ&lt;cache-ref/&gt;æ ‡ç­¾æ¥å¼€å¯å’Œé…ç½®ç¼“å­˜
  3. &lt;select useCache = &quot;true&quot;/&gt; åªæœ‰1ã€2éƒ½å¯ç”¨ä¹‹åè¿™ä¸ªæ‰ç”Ÿæ•ˆï¼Œé»˜è®¤ä¸ºtrue
  4. &lt;select flushCache = &quot;true&quot;/&gt; åœ¨æ‰§è¡Œè¯­å¥ä¹‹å‰æ˜¯å¦æ¸…ç†ä¸€çº§äºŒçº§ç¼“å­˜
  å¼€å¯äºŒçº§ç¼“å­˜--&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3-transactionåŒ…" tabindex="-1"><a class="header-anchor" href="#_1-3-transactionåŒ…" aria-hidden="true">#</a> 1.3 transactionåŒ…</h3><p>äº‹åŠ¡åŒ…é‡Œé¢çš„é€»è¾‘æ¯”è¾ƒç®€å•æä¾›äº†2ä¸ªæ¥å£ï¼ˆäº‹åŠ¡æ¥å£å’Œäº‹åŠ¡å·¥å‚ï¼‰å¹¶å„è‡ªæœ‰2ä¸ªå®ç°ï¼ˆjdbcå’Œmanagedï¼‰ã€‚æ¥å£æºç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Transaction</span> <span class="token punctuation">{</span>

  <span class="token comment">// è·å–è¿æ¥</span>
  <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>

  <span class="token comment">// äº‹åŠ¡æäº¤</span>
  <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>

  <span class="token comment">// äº‹åŠ¡å›æ»š</span>
  <span class="token keyword">void</span> <span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>

  <span class="token comment">// äº‹åŠ¡å–æ¶ˆ</span>
  <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>

  <span class="token comment">// è·å–è¶…æ—¶æ—¶é—´</span>
  <span class="token class-name">Integer</span> <span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TransactionFactory</span> <span class="token punctuation">{</span>

  <span class="token doc-comment comment">/**
   * Sets transaction factory custom properties.
   * <span class="token keyword">@param</span> <span class="token parameter">props</span>
   *          the new properties
   */</span>
  <span class="token comment">// è®¾ç½®å±æ€§</span>
  <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// NOP</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// åˆ›å»ºäº‹åŠ¡é€šè¿‡æ•°æ®åº“è¿æ¥</span>
  <span class="token class-name">Transaction</span> <span class="token function">newTransaction</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> conn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// åˆ›å»ºäº‹åŠ¡é€šè¿‡æ•°æ®æºå’Œäº‹åŠ¡éš”ç¦»çº§åˆ«</span>
  <span class="token class-name">Transaction</span> <span class="token function">newTransaction</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">,</span> <span class="token class-name">TransactionIsolationLevel</span> level<span class="token punctuation">,</span> <span class="token keyword">boolean</span> autoCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>jdbcäº‹åŠ¡å®ç°ç±»å¦‚ä¸‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// jdbcäº‹åŠ¡</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcTransaction</span> <span class="token keyword">implements</span> <span class="token class-name">Transaction</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> log <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">JdbcTransaction</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ•°æ®åº“è¿æ¥</span>
  <span class="token keyword">protected</span> <span class="token class-name">Connection</span> connection<span class="token punctuation">;</span>
  <span class="token comment">// æ•°æ®æº</span>
  <span class="token keyword">protected</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>
  <span class="token comment">// äº‹åŠ¡éš”ç¦»çº§åˆ«</span>
  <span class="token keyword">protected</span> <span class="token class-name">TransactionIsolationLevel</span> level<span class="token punctuation">;</span>
  <span class="token comment">// æ˜¯å¦è‡ªåŠ¨æäº¤</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> autoCommit<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">JdbcTransaction</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> ds<span class="token punctuation">,</span> <span class="token class-name">TransactionIsolationLevel</span> desiredLevel<span class="token punctuation">,</span> <span class="token keyword">boolean</span> desiredAutoCommit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dataSource <span class="token operator">=</span> ds<span class="token punctuation">;</span>
    level <span class="token operator">=</span> desiredLevel<span class="token punctuation">;</span>
    autoCommit <span class="token operator">=</span> desiredAutoCommit<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">JdbcTransaction</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connection <span class="token operator">=</span> connection<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿æ¥ä¸ºç©ºåˆ™æ‰“å¼€è¿æ¥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> connection<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœè¿æ¥ä¸ä¸ºç©ºä¸è¿æ¥éè‡ªåŠ¨æäº¤åˆ™æäº¤</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">getAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Committing JDBC Connection [&quot;</span> <span class="token operator">+</span> connection <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      connection<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœè¿æ¥ä¸ä¸ºç©ºä¸è¿æ¥éè‡ªåŠ¨æäº¤åˆ™å›æ»š</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">getAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Rolling back JDBC Connection [&quot;</span> <span class="token operator">+</span> connection <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      connection<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// é‡ç½®è‡ªåŠ¨æäº¤</span>
      <span class="token function">resetAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Closing JDBC Connection [&quot;</span> <span class="token operator">+</span> connection <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">resetAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœæ˜¯falseåˆ™é‡ç½®ä¸ºtrue</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">getAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Resetting autocommit to true on JDBC Connection [&quot;</span> <span class="token operator">+</span> connection <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        connection<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Error resetting autocommit to true &quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;before closing the connection.  Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Opening JDBC Connection&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    connection <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ä¸ºç©ºåˆ™è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      connection<span class="token punctuation">.</span><span class="token function">setTransactionIsolation</span><span class="token punctuation">(</span>level<span class="token punctuation">.</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è®¾ç½®è‡ªåŠ¨æäº¤</span>
    <span class="token function">setDesiredAutoCommit</span><span class="token punctuation">(</span>autoCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä»–çš„å·¥å‚ç±»éƒ½æ˜¯newäº†ä¸€ä¸ªäº‹åŠ¡æ¥å£çš„å„è‡ªå®ç°ç±»ã€‚äº‹åŠ¡ç®¡ç†æ“ä½œçš„å®ç°ç±»ä¹Ÿå·®ä¸å¤šï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯æäº¤å’Œå›æ»šéƒ½æ²¡æœ‰å®ç°æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•éƒ½äº¤ç»™äº†å®¹å™¨å»å¤„ç†ã€‚æ¯”å¦‚æ‰€æœ‰çš„äº‹åŠ¡æ“ä½œéƒ½å§”æ‰˜ç»™äº†springã€‚</p><h3 id="_1-4-cursoråŒ…" tabindex="-1"><a class="header-anchor" href="#_1-4-cursoråŒ…" aria-hidden="true">#</a> 1.4 cursoråŒ…</h3><p>æ¸¸æ ‡ä¸»è¦çš„ä½œç”¨å°±æ˜¯è·å–æ•°æ®åˆ—è¡¨ä¹‹åé€æ¡è¯»å‡ºã€‚æ¯”å¦‚æ•°æ®åº“æŸ¥è¯¢ç»“æœæœ‰10æ¡ï¼Œåˆ™æ•°æ®ä¼šæŸ¥è¯¢åˆ°å†…å­˜åé€æ¡ç»™å‡ºï¼Œä½¿ç”¨æ–¹å¼ï¼šCursor&lt;å¯¹è±¡&gt;ã€‚è¿™ä¸ªåŒ…é‡Œé¢ä¸€å…±å°±ä¸¤ä¸ªç±»ï¼Œä¸€ä¸ªæ¸¸æ ‡æ¥å£ä¸€ä¸ªæ¸¸æ ‡é»˜è®¤å®ç°ç±»ï¼Œæ¸¸æ ‡æ¥å£ç»§æ‰¿äº†å…‹éš†å’Œå¯è¿­ä»£å™¨æ¥å£é»˜è®¤å®ç°ç±»å°±è¦å®ç°æ‰€æœ‰çš„æ–¹æ³•ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// æ¸¸æ ‡ ç»§æ‰¿äº†è¿­ä»£å™¨ï¼ˆå¤„ç†å¤§é‡æ•°æ®æ—¶ä½¿ç”¨ï¼‰</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Cursor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Closeable</span><span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// æ˜¯å¦å¼€å¯</span>
  <span class="token keyword">boolean</span> <span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ˜¯å¦å·²ç»å®Œæˆéå†</span>
  <span class="token keyword">boolean</span> <span class="token function">isConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿”å›å½“å‰å…ƒç´ çš„ç´¢å¼•</span>
  <span class="token keyword">int</span> <span class="token function">getCurrentIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultCursor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Cursor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

  <span class="token comment">// ResultSetHandler stuff</span>
  <span class="token comment">// ç»“æœå¤„ç†çº§</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DefaultResultSetHandler</span> resultSetHandler<span class="token punctuation">;</span>
  <span class="token comment">// ç»“æœé›†å¯¹äºçš„resultMapä¿¡æ¯</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ResultMap</span> resultMap<span class="token punctuation">;</span>
  <span class="token comment">// è¿”å›ç»“æœçš„è¯¦ç»†ä¿¡æ¯ï¼ˆæ‰€æœ‰æ•°æ®éƒ½æŸ¥è¯¢åœ¨æ­¤å¤„ï¼‰</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ResultSetWrapper</span> rsw<span class="token punctuation">;</span>
  <span class="token comment">// ç»“æœçš„èµ·æ­¢ä¿¡æ¯</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">;</span>
  <span class="token comment">// æš‚å­˜ç»“æœ</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">ObjectWrapperResultHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> objectWrapperResultHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectWrapperResultHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å†…éƒ¨è¿­ä»£å™¨</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CursorIterator</span> cursorIterator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CursorIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿­ä»£å™¨å­˜åœ¨æ ‡å¿—ä½</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> iteratorRetrieved<span class="token punctuation">;</span>
  <span class="token comment">// æ¸¸æ ‡çŠ¶æ€</span>
  <span class="token keyword">private</span> <span class="token class-name">CursorStatus</span> status <span class="token operator">=</span> <span class="token class-name">CursorStatus</span><span class="token punctuation">.</span><span class="token constant">CREATED</span><span class="token punctuation">;</span>
  <span class="token comment">// è®°å½•å·²ç»æ˜ å°„çš„è¡Œ</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> indexWithRowBound <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// æ¸¸æ ‡çŠ¶æ€</span>
  <span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">CursorStatus</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ–°åˆ›å»ºæ¸¸æ ‡ï¼Œç»“æœæœªæ¶ˆè´¹</span>
    <span class="token constant">CREATED</span><span class="token punctuation">,</span>
    <span class="token comment">// æ­£åœ¨è¢«ä½¿ç”¨ï¼Œæ­£åœ¨è¢«æ¶ˆè´¹</span>
    <span class="token constant">OPEN</span><span class="token punctuation">,</span>sed cursor<span class="token punctuation">,</span> not fully consumed<span class="token punctuation">.</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token comment">// æ¸¸æ ‡å·²ç»è¢«å…³é—­ï¼Œç»“æœæœªè¢«å…¨éƒ¨å…³é—­</span>
    <span class="token constant">CLOSED</span><span class="token punctuation">,</span>
    <span class="token comment">// æ¸¸æ ‡å·²ç»è¢«å…³é—­ï¼Œç»“æœå…¨éƒ¨å…³é—­</span>
    <span class="token constant">CONSUMED</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">DefaultCursor</span><span class="token punctuation">(</span><span class="token class-name">DefaultResultSetHandler</span> resultSetHandler<span class="token punctuation">,</span> <span class="token class-name">ResultMap</span> resultMap<span class="token punctuation">,</span> <span class="token class-name">ResultSetWrapper</span> rsw<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resultSetHandler <span class="token operator">=</span> resultSetHandler<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resultMap <span class="token operator">=</span> resultMap<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rsw <span class="token operator">=</span> rsw<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rowBounds <span class="token operator">=</span> rowBounds<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœè¿­ä»£å™¨å·²ç»ç»™å‡º</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iteratorRetrieved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot open more than one iterator on a Cursor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœæ¸¸æ ‡å·²ç»å…³é—­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;A Cursor is already closed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¡¨é¢å·²ç»ç»™å‡ºå¹¶è¿”å›</span>
    iteratorRetrieved <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cursorIterator<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// è€ƒè™‘è¾¹ç•Œé™åˆ¶ï¼Œä»æ•°æ®åº“ä¸­è·å–ä¸‹ä¸€ä¸ªå¯¹è±¡</span>
  <span class="token keyword">protected</span> <span class="token class-name">T</span> <span class="token function">fetchNextUsingRowBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»æ•°æ®åº“ç»“æœä¸­å–å‡ºä¸‹ä¸€ä¸ªå¯¹è±¡</span>
    <span class="token class-name">T</span> result <span class="token operator">=</span> <span class="token function">fetchNextObjectFromDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¸æ»¡è¶³è¾¹ç•Œé™åˆ¶åˆ™ä¸€ç›´å»å–</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>objectWrapperResultHandler<span class="token punctuation">.</span>fetched <span class="token operator">&amp;&amp;</span> indexWithRowBound <span class="token operator">&lt;</span> rowBounds<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> <span class="token function">fetchNextObjectFromDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ä»æ•°æ®åº“è·å–ä¸‹ä¸€ä¸ªå¯¹è±¡</span>
  <span class="token keyword">protected</span> <span class="token class-name">T</span> <span class="token function">fetchNextObjectFromDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      objectWrapperResultHandler<span class="token punctuation">.</span>fetched <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      status <span class="token operator">=</span> <span class="token class-name">CursorStatus</span><span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">;</span>
      <span class="token comment">// ç»“æœé›†æ²¡æœ‰å…³é—­</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rsw<span class="token punctuation">.</span><span class="token function">getResultSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä»ç»“æœé›†å–å‡ºæ•°æ®å¹¶å­˜å…¥resultSetHandlerä¸­</span>
        resultSetHandler<span class="token punctuation">.</span><span class="token function">handleRowValues</span><span class="token punctuation">(</span>rsw<span class="token punctuation">,</span> resultMap<span class="token punctuation">,</span> objectWrapperResultHandler<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è·å–å­˜å…¥objectWrapperResultHandlerçš„å¯¹è±¡</span>
    <span class="token class-name">T</span> next <span class="token operator">=</span> objectWrapperResultHandler<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>objectWrapperResultHandler<span class="token punctuation">.</span>fetched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ›´æ”¹ç´¢å¼•</span>
      indexWithRowBound<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ²¡æœ‰æ–°å¯¹è±¡æˆ–è€…åˆ°è¾¾äº†è¾¹ç•Œ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>objectWrapperResultHandler<span class="token punctuation">.</span>fetched <span class="token operator">||</span> <span class="token function">getReadItemsCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> rowBounds<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> rowBounds<span class="token punctuation">.</span><span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ•°æ®æ¶ˆè´¹å®Œæ¯•</span>
      <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      status <span class="token operator">=</span> <span class="token class-name">CursorStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUMED</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ¸…é™¤å¯¹è±¡</span>
    objectWrapperResultHandler<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ç®€å•çš„ç»“æœå¤„ç†å™¨</span>
  <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ObjectWrapperResultHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ResultHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token class-name">T</span> result<span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> fetched<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleResult</span><span class="token punctuation">(</span><span class="token class-name">ResultContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å–å‡ºä¸Šä¸‹æ–‡ä¸­çš„ä¸€æ¡ç»“æœ</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>result <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResultObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// å…³é—­ç»“æœä¸Šä¸‹æ–‡</span>
      context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      fetched <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token keyword">class</span> <span class="token class-name">CursorIterator</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  
    <span class="token comment">// ç¼“å­˜ä¸‹ä¸€ä¸ªè¦è¿”å›çš„å¯¹è±¡ï¼Œåœ¨nextæ“ä½œä¸­å®Œæˆå†™å…¥</span>
    <span class="token class-name">T</span> object<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * Index of objects returned using next(), and as such, visible to users.
     */</span>
    <span class="token comment">// nextæ–¹æ³•ä¸­è¿”å›çš„å¯¹è±¡ç´¢å¼•</span>
    <span class="token keyword">int</span> iteratorIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæœ‰åˆ™å†™å…¥object</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>objectWrapperResultHandler<span class="token punctuation">.</span>fetched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        object <span class="token operator">=</span> <span class="token function">fetchNextUsingRowBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> objectWrapperResultHandler<span class="token punctuation">.</span>fetched<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿”å›ä¸‹ä¸€ä¸ªå…ƒç´ </span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Fill next with object fetched from hasNext()</span>
      <span class="token class-name">T</span> next <span class="token operator">=</span> object<span class="token punctuation">;</span>
      <span class="token comment">// å¦‚æœæ²¡æœ‰å¯¹è±¡åˆ™å°è¯•å»è·å–ä¸€ä¸ª</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>objectWrapperResultHandler<span class="token punctuation">.</span>fetched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        next <span class="token operator">=</span> <span class="token function">fetchNextUsingRowBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// æ¸…ç©ºè¿”å›next</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>objectWrapperResultHandler<span class="token punctuation">.</span>fetched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        objectWrapperResultHandler<span class="token punctuation">.</span>fetched <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        object <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        iteratorIndex<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> next<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-5-executoråŒ…" tabindex="-1"><a class="header-anchor" href="#_1-5-executoråŒ…" aria-hidden="true">#</a> 1.5 executoråŒ…</h3><p>è¿™ä¸ªåŒ…æ˜¯mybatisæœ€é‡è¦çš„åŒ…ï¼Œçœ‹äº†ä¸‹ç±»ä¹Ÿæ˜¯ç‰¹åˆ«çš„å¤šï¼ŒæŒ‰ç…§é‡Œçš„å­åŒ…åˆ†ä¸€ä¸‹ç±»keygenå­åŒ…(ç”Ÿæˆè‡ªå¢ä¸»é”®)ã€loaderå­åŒ…ï¼ˆæ‡’åŠ è½½ï¼‰ã€parameterå­åŒ…ã€resultå­åŒ…ã€resultSetå­åŒ…ã€statementå­åŒ…ã€æ‰§è¡Œå™¨æ ¸å¿ƒç±»</p><h4 id="_1-5-2-keygenå­åŒ…-ç”Ÿæˆè‡ªå¢ä¸»é”®" tabindex="-1"><a class="header-anchor" href="#_1-5-2-keygenå­åŒ…-ç”Ÿæˆè‡ªå¢ä¸»é”®" aria-hidden="true">#</a> 1.5.2 keygenå­åŒ…(ç”Ÿæˆè‡ªå¢ä¸»é”®)</h4><p>åŒ…é‡Œé¢æœ‰ä¸€ä¸ªæ¥å£ä¸‰ä¸ªå®ç°ç±»NoKeyGeneratorä¸æä¾›ä»»ä½•è‡ªå¢ä¸»é”®ã€Jdbc3KeyGeneratorç»™æä¾›è‡ªå¢ä¸»é”®çš„æ•°æ®åº“ã€SelectKeyGeneratoræ˜¯Jdbc3KeyGeneratorçš„å¢å¼ºç‰ˆé€šè¿‡åœ¨æ‰§è¡Œè¯­å¥çš„å‰é¢æˆ–è€…åé¢å»æ‰§è¡Œè¯­å¥ã€‚è¿™ä¸‰ä¸ªå®ç°ç±»åªèƒ½æœ‰ä¸€ä¸ªè¢«ä½¿ç”¨ï¼Œå¦‚æœåŒæ—¶åŠ äº†selectKeyå’ŒuseGeneratedåˆ™ä»¥selectKeyç”Ÿæ•ˆã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> è‡ªå¢è®¾ç½® <span class="token class-name">Jdbc3KeyGenerator</span> javaå¯¹è±¡æ’å…¥åå°†è‡ªå¢<span class="token constant">ID</span>å›æ˜¾ç»™å¯¹è±¡ <span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>insert id<span class="token operator">=</span><span class="token string">&quot;getAllUserInfo&quot;</span> useGeneratedKeys<span class="token operator">=</span><span class="token string">&quot;true&quot;</span> keyProperty<span class="token operator">=</span><span class="token string">&quot;id&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>insert<span class="token operator">&gt;</span>

  <span class="token operator">&lt;</span>insert id<span class="token operator">=</span><span class="token string">&quot;selectList&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> è‡ªå¢è®¾ç½® <span class="token class-name">SelectKeyGenerator</span> javaå¯¹è±¡æ’å…¥åå°†è‡ªå¢<span class="token constant">ID</span>å›æ˜¾ç»™å¯¹è±¡å¯ä»¥è®¾ç½® <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>selectKey resultType<span class="token operator">=</span><span class="token string">&quot;java.lang.Integer&quot;</span> keyProperty<span class="token operator">=</span><span class="token string">&quot;id&quot;</span> order<span class="token operator">=</span><span class="token string">&quot;BEFORE&quot;</span> <span class="token operator">&gt;</span><span class="token comment">//AFTER</span>
      <span class="token class-name">SELECT</span> <span class="token function">LAST_INSERT_ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>selectKey<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>insert<span class="token operator">&gt;</span>
    
  <span class="token comment">// keyç”Ÿæˆæ¥å£</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">KeyGenerator</span> <span class="token punctuation">{</span>

  <span class="token comment">// æ•°æ®æ’å…¥å‰è¿›è¡Œçš„æ“ä½œ</span>
  <span class="token keyword">void</span> <span class="token function">processBefore</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Statement</span> stmt<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// æ•°æ®æ’å…¥åè¿›è¡Œçš„æ“ä½œ</span>
  <span class="token keyword">void</span> <span class="token function">processAfter</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Statement</span> stmt<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…·æœ‰è‡ªå¢ç»„ä»¶çš„æ•°æ®åº“å‡†å¤‡çš„ï¼ˆè·å–æ•°æ®åº“ç”Ÿæˆçš„ä¸»é”®å€¼ï¼Œæä¾›ä¸»é”®çš„å›å†™åŠŸèƒ½ï¼‰Jdbc3KeyGenerator</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token comment">// æ‰§è¡Œsqlå‰ä¸åšä»»ä½•å¤„ç†</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processBefore</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Statement</span> stmt<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do nothing</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token comment">// æ‰§è¡Œsqlå</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processAfter</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Statement</span> stmt<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">processBatch</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> stmt<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processBatch</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Statement</span> stmt<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‹¿åˆ°ä¸»é”®çš„å±æ€§åç§°</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyProperties <span class="token operator">=</span> ms<span class="token punctuation">.</span><span class="token function">getKeyProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>keyProperties <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> keyProperties<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// java.sql.Statement.getGeneratedKeys()è¿”å›è‡ªå¢ä¸»é”®çš„ResultSetï¼Œ å¦‚æœæ²¡æœ‰åˆ™è¿”å›ç©ºResultSetå¯¹è±¡</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> stmt<span class="token punctuation">.</span><span class="token function">getGeneratedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¾“å‡ºç»“æœçš„æè¿°ä¿¡æ¯</span>
      <span class="token keyword">final</span> <span class="token class-name">ResultSetMetaData</span> rsmd <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> ms<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rsmd<span class="token punctuation">.</span><span class="token function">getColumnCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> keyProperties<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Error?</span>
        <span class="token comment">// æ•°æ®åº“è·å–çš„å­—æ®µæ¯”å±æ€§çš„å­—æ®µè¿˜è¦å¤šï¼Œåº”è¯¥è¿™é‡Œåªæ˜¯è¿”æ˜¾IDåˆ™ä¸åšå¤„ç†</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// è°ƒç”¨è‡ªæ–¹æ³•ï¼Œå°†ä¸»é”®èµ‹å€¼ç»™å®å‚æ•°</span>
        <span class="token function">assignKeys</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> rs<span class="token punctuation">,</span> rsmd<span class="token punctuation">,</span> keyProperties<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutorException</span><span class="token punctuation">(</span><span class="token string">&quot;Error getting generated key or setting result to parameter object. Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çœŸæ­£çš„ç”Ÿæˆä¸»é”®SelectKeyGenerator</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ä¸»é”®sqlè¯­å¥çš„ç‰¹æœ‰æ ‡è®°</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SELECT_KEY_SUFFIX</span> <span class="token operator">=</span> <span class="token string">&quot;!selectKey&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// æ˜¯å¦æ’å…¥å‰æ‰§è¡Œ</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> executeBefore<span class="token punctuation">;</span>
  <span class="token comment">// ç”¨æˆ·ç”Ÿæˆè¯­å¥çš„sqlè¯­å¥</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MappedStatement</span> keyStatement<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">SelectKeyGenerator</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> keyStatement<span class="token punctuation">,</span> <span class="token keyword">boolean</span> executeBefore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>executeBefore <span class="token operator">=</span> executeBefore<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>keyStatement <span class="token operator">=</span> keyStatement<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * æ•°æ®æ’å…¥å‰è¿›è¡Œçš„æ“ä½œ
   * 1. æ•°æ®åº“å­˜åœ¨è‡ªå¢ä¸»é”®ï¼šåœ¨æ‰§è¡Œç‰¹å®šsqlè¯­å¥åèµ‹å€¼ä¸»é”®åæ’å…¥æ•°æ®åº“ä¼šå‡ºç°ç”Ÿæˆçš„å’Œæ•°æ®åº“ä¸ä¸€è‡´ã€‚è¿™æ˜¯å»ºè®®ä½¿ç”¨Jdbc3KeyGenerator
   * 2. æ•°æ®åº“ä¸å­˜åœ¨è‡ªå¢ä¸»é”®ï¼šåœ¨æ‰§è¡Œç‰¹å®šsqlè¯­å¥åèµ‹å€¼ä¸»é”®åå®Œæ•´æ’å…¥æ•°æ®åº“ *
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processBefore</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Statement</span> stmt<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executeBefore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">processGeneratedKeys</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> ms<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * æ•°æ®æ’å…¥åè¿›è¡Œçš„æ“ä½œ
   * 1. æ•°æ®åº“å­˜åœ¨è‡ªå¢ä¸»é”®ï¼šå¯èƒ½å‡ºç°æ•°æ®åº“å’Œjavaå¯¹è±¡çš„å€¼ä¸ä¸€è‡´ï¼Œä¸€èˆ¬é€šè¿‡ç‰¹å®šçš„sqlè¯­å¥ä¿è¯ä¸€è‡´å’ŒJdbc3KeyGeneratorå›å†™åŠŸèƒ½ç±»ä¼¼ *
   * 2. æ•°æ®åº“ä¸å­˜åœ¨è‡ªå¢ä¸»é”®ï¼šæ’å…¥æ•°æ®åº“çš„æ•°æ®æ²¡æœ‰èµ‹å€¼ï¼Œè€Œjavaå¯¹è±¡ç¡®èµ‹å€¼äº†ã€‚æ“ä½œé”™è¯¯
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processAfter</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Statement</span> stmt<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>executeBefore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">processGeneratedKeys</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> ms<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æ‰§è¡Œç‰¹å®šçš„sqlè¯­å¥ä¹‹åï¼Œå°†å€¼èµ‹ç»™javaå¯¹è±¡</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processGeneratedKeys</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆ¤ç©º</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> keyStatement <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> keyStatement<span class="token punctuation">.</span><span class="token function">getKeyProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// éœ€è¦è‡ªå¢çš„å±æ€§</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyProperties <span class="token operator">=</span> keyStatement<span class="token punctuation">.</span><span class="token function">getKeyProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> ms<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">MetaObject</span> metaParam <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">newMetaObject</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Do not close keyExecutor.</span>
        <span class="token comment">// The transaction will be closed by parent executor.</span>
        <span class="token comment">// ç»™keyåˆ›å»ºæ‰§è¡Œå™¨</span>
        <span class="token class-name">Executor</span> keyExecutor <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">newExecutor</span><span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ExecutorType</span><span class="token punctuation">.</span><span class="token constant">SIMPLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ‰§è¡Œsqlè¯­å¥å¾—åˆ°ä¸»é”®å€¼</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> values <span class="token operator">=</span> keyExecutor<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>keyStatement<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">,</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token constant">NO_RESULT_HANDLER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¸»é”®å¿…é¡»å”¯ä¸€</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutorException</span><span class="token punctuation">(</span><span class="token string">&quot;SelectKey returned no data.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutorException</span><span class="token punctuation">(</span><span class="token string">&quot;SelectKey returned more than one value.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token class-name">MetaObject</span> metaResult <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">newMetaObject</span><span class="token punctuation">(</span>values<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>keyProperties<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ä¸»é”®åªæœ‰ä¸€ä¸ªåè¿›è¡Œèµ‹å€¼</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>metaResult<span class="token punctuation">.</span><span class="token function">hasGetter</span><span class="token punctuation">(</span>keyProperties<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// åœ¨metaResultä¸­ç”¨getterè·å–å€¼</span>
              <span class="token function">setValue</span><span class="token punctuation">(</span>metaParam<span class="token punctuation">,</span> keyProperties<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> metaResult<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>keyProperties<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// no getter for the property - maybe just a single value object</span>
              <span class="token comment">// so try that</span>
              <span class="token comment">// è¿”å›çš„ç›´æ¥å°±æ˜¯ä¸»é”®æœ¬èº«</span>
              <span class="token function">setValue</span><span class="token punctuation">(</span>metaParam<span class="token punctuation">,</span> keyProperties<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> values<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¾—åˆ°çš„å€¼èµ‹å€¼ç»™å¤šä¸ªå±æ€§</span>
            <span class="token function">handleMultipleProperties</span><span class="token punctuation">(</span>keyProperties<span class="token punctuation">,</span> metaParam<span class="token punctuation">,</span> metaResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutorException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutorException</span><span class="token punctuation">(</span><span class="token string">&quot;Error selecting key or setting result to parameter object. Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-5-2-loaderå­åŒ…-æ‡’åŠ è½½" tabindex="-1"><a class="header-anchor" href="#_1-5-2-loaderå­åŒ…-æ‡’åŠ è½½" aria-hidden="true">#</a> 1.5.2 loaderå­åŒ…ï¼ˆæ‡’åŠ è½½ï¼‰</h4><p>ä¸»è¦çš„åŠŸèƒ½æ˜¯åœ¨å…³è”è¡¨æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‰éœ€æ‡’åŠ è½½å¦å¤–ä¸€å¼ è¡¨é‡Œé¢çš„æ•°æ®ã€‚å³å¯ä»¥å®ç°å…ˆè·å–ä¸»è¡¨é‡Œé¢çš„æ•°æ®ï¼Œä¹‹ååœ¨æ‡’åŠ è½½è·å–å…³è”è¡¨æ•°æ®ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘å…³è”è¡¨çš„å†—ä½™æŸ¥è¯¢æ•°æ®ã€‚å®ç°åŸç†å°±æ˜¯ç»™éœ€è¦æ‡’åŠ è½½çš„ç±»åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼Œåœ¨è°ƒç”¨getæ–¹æ³•çš„æ—¶å€™å°±å»åˆ¤æ–­å±æ€§æ˜¯å¦æ˜¯æ‡’åŠ è½½å±æ€§ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ç›¸åº”çš„è¯­å¥æŸ¥è¯¢ç»“æœåèµ‹å€¼ç»™å±æ€§ã€‚</p><p>ä½¿ç”¨æ–¹å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>  <span class="token comment">&lt;!-- mybatis-config.xmlé‡Œé¢å¼€å¯æ‡’åŠ è½½é…ç½® --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>settings</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- å…¨å±€æ€§è®¾ç½®æ‡’åŠ è½½ã€‚å¦‚æœè®¾ä¸ºâ€˜false&#39;ï¼Œåˆ™æ‰€æœ‰ç›¸å…³è”çš„éƒ½ä¼šè¢«åˆå§‹åŒ–åŠ è½½ã€‚ --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>lazyLoadingEnabled<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- å½“è®¾ç½®ä¸ºâ€˜true&#39;çš„æ—¶å€™ï¼Œæ‡’åŠ è½½çš„å¯¹è±¡å¯èƒ½è¢«ä»»ä½•æ‡’å±æ€§å…¨éƒ¨åŠ è½½ã€‚å¦åˆ™ï¼Œæ¯ä¸ªå±æ€§éƒ½æŒ‰éœ€åŠ è½½ã€‚ --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aggressiveLazyLoading<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>settings</span><span class="token punctuation">/&gt;</span></span>  
  
    <span class="token comment">&lt;!-- ç»“æœæ˜ å°„è¯­å¥ --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userInfo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getUserInfo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">autoMapping</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- select: æŒ‡å®šå»¶è¿ŸåŠ è½½éœ€è¦æ‰§è¡Œçš„statementçš„idï¼ˆæ ¹æ®idæŸ¥è¯¢çš„statementï¼‰å¦‚æœä¸åœ¨æœ¬æ–‡ä»¶ä¸­ï¼Œéœ€è¦åŠ ä¸Šnamespace
         property: resultMapä¸­typeæŒ‡å®šç±»ä¸­çš„å±æ€§å
         column:å’ŒselectæŸ¥è¯¢å…³è”çš„å­—æ®µï¼ˆresultMapä¸­å­˜åœ¨çš„å­—æ®µï¼‰
     --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>association</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userRole<span class="token punctuation">&quot;</span></span> <span class="token attr-name">javaType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userRole<span class="token punctuation">&quot;</span></span> <span class="token attr-name">autoMapping</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token attr-name">select</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getUserRoseByUserId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>association</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!--  maper.xmlé‡Œé¢çš„æŸ¥è¯¢è¯­å¥  --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getUsers<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getUserInfo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    select * from user_info
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token comment">&lt;!--  æ‡’åŠ è½½å­å¥  --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getUserRoseByUserId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userRole<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    select * from user_role where user_id = #{userId}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
  
    // æµ‹è¯•æ‡’åŠ è½½
    // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¹¶è¿”å›ç”¨æˆ·ä¿¡æ¯çš„ä»£ç†å¯¹è±¡
    List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserInfo</span><span class="token punctuation">&gt;</span></span> users = userInfoMapper.getUsers();
    for (UserInfo user : users) {
      // è°ƒç”¨æ‡’åŠ è½½è·å–æ•°æ®
      UserRole userRole = user.getUserRole();
      if(userRole != null ){
        System.out.println(userRole.toString());
      }
    }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»ºæ‡’åŠ è½½ä»£ç†å·¥å‚å †æ ˆï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// åˆ¤æ–­æ¡ä»¶ååˆ›å»ºæ‡’åŠ è½½çš„åŠ¨æ€å¯¹è±¡</span>
createResultObject<span class="token operator">:</span><span class="token number">671</span><span class="token punctuation">,</span> <span class="token class-name">DefaultResultSetHandler</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>resultset<span class="token punctuation">)</span>
<span class="token comment">// è¿”å›ç»“æœå¤„ç†  </span>
getRowValue<span class="token operator">:</span><span class="token number">427</span><span class="token punctuation">,</span> <span class="token class-name">DefaultResultSetHandler</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>resultset<span class="token punctuation">)</span>
handleRowValuesForSimpleResultMap<span class="token operator">:</span><span class="token number">380</span><span class="token punctuation">,</span> <span class="token class-name">DefaultResultSetHandler</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>resultset<span class="token punctuation">)</span>
handleRowValues<span class="token operator">:</span><span class="token number">349</span><span class="token punctuation">,</span> <span class="token class-name">DefaultResultSetHandler</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>resultset<span class="token punctuation">)</span>
handleResultSet<span class="token operator">:</span><span class="token number">317</span><span class="token punctuation">,</span> <span class="token class-name">DefaultResultSetHandler</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>resultset<span class="token punctuation">)</span>
handleResultSets<span class="token operator">:</span><span class="token number">201</span><span class="token punctuation">,</span> <span class="token class-name">DefaultResultSetHandler</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>resultset<span class="token punctuation">)</span>
<span class="token comment">// è¯­å¥å¤„ç†  </span>
query<span class="token operator">:</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token class-name">PreparedStatementHandler</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>statement<span class="token punctuation">)</span>  
query<span class="token operator">:</span><span class="token number">84</span><span class="token punctuation">,</span> <span class="token class-name">RoutingStatementHandler</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>statement<span class="token punctuation">)</span>
doQuery<span class="token operator">:</span><span class="token number">66</span><span class="token punctuation">,</span> <span class="token class-name">SimpleExecutor</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">)</span>
<span class="token comment">// ä»æ•°æ®åº“è¿›è¡ŒæŸ¥è¯¢æ“ä½œå‰çš„æœ¬åœ°ç¼“å­˜å¤„ç†</span>
queryFromDatabase<span class="token operator">:</span><span class="token number">351</span><span class="token punctuation">,</span> <span class="token class-name">BaseExecutor</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">)</span>  
query<span class="token operator">:</span><span class="token number">174</span><span class="token punctuation">,</span> <span class="token class-name">BaseExecutor</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">)</span>
<span class="token comment">// ç¼“å­˜æ‰§è¡Œå™¨æŸ¥è¯¢æ¥å£  </span>
query<span class="token operator">:</span><span class="token number">115</span><span class="token punctuation">,</span> <span class="token class-name">CachingExecutor</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">)</span>
query<span class="token operator">:</span><span class="token number">94</span><span class="token punctuation">,</span> <span class="token class-name">CachingExecutor</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">)</span>
<span class="token comment">// DefaultSqlSessionæŸ¥è¯¢åˆ—è¡¨æ¥å£  </span>
selectList<span class="token operator">:</span><span class="token number">159</span><span class="token punctuation">,</span> <span class="token class-name">DefaultSqlSession</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>defaults<span class="token punctuation">)</span>
selectList<span class="token operator">:</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token class-name">DefaultSqlSession</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>defaults<span class="token punctuation">)</span>
selectList<span class="token operator">:</span><span class="token number">145</span><span class="token punctuation">,</span> <span class="token class-name">DefaultSqlSession</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>defaults<span class="token punctuation">)</span>
<span class="token comment">// æ‰§è¡Œè¿”å›å¤šæ¡æ•°æ®æ–¹æ³•  </span>
executeForMany<span class="token operator">:</span><span class="token number">162</span><span class="token punctuation">,</span> <span class="token class-name">MapperMethod</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>binding<span class="token punctuation">)</span>
execute<span class="token operator">:</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token class-name">MapperMethod</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>binding<span class="token punctuation">)</span>
<span class="token comment">// mybatisçš„åŠ¨æ€ä»£ç†ç±»å®ç°ç±»</span>
invoke<span class="token operator">:</span><span class="token number">154</span><span class="token punctuation">,</span> <span class="token class-name">MapperProxy</span>$<span class="token class-name">PlainMethodInvoker</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>binding<span class="token punctuation">)</span>
invoke<span class="token operator">:</span><span class="token number">89</span><span class="token punctuation">,</span> <span class="token class-name">MapperProxy</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>binding<span class="token punctuation">)</span>
<span class="token comment">// jdkåŠ¨æ€ä»£ç†  </span>
getUsers<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> $<span class="token class-name">Proxy6</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>proxy<span class="token punctuation">)</span>
<span class="token comment">// mainæ–¹æ³•è°ƒç”¨ </span>
main<span class="token operator">:</span><span class="token number">52</span><span class="token punctuation">,</span> <span class="token class-name">MybatisTest</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>gqs<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>test<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‡’åŠ è½½çš„ä»£ç†å·¥å‚æºç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProxyFactory</span> <span class="token punctuation">{</span>

  <span class="token comment">// è®¾ç½®å®ç°æ–¹æ³•ï¼Œ</span>
  <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// NOP</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡</span>
  <span class="token class-name">Object</span> <span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token class-name">ResultLoaderMap</span> lazyLoader<span class="token punctuation">,</span> <span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span> objectFactory<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> constructorArgTypes<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> constructorArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>createProxyçš„å®ç°ç±»å°±æ˜¯CglibProxyFactoryæºç </p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// åˆ›å»ºä¸€ä¸ªååºåˆ—åŒ–çš„ä»£ç†å¯¹è±¡</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">createDeserializationProxy</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ResultLoaderMap<span class="token punctuation">.</span>LoadPair</span><span class="token punctuation">&gt;</span></span> unloadedProperties<span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span> objectFactory<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> constructorArgTypes<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> constructorArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">EnhancedDeserializationProxyImpl</span><span class="token punctuation">.</span><span class="token function">createProxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> unloadedProperties<span class="token punctuation">,</span> objectFactory<span class="token punctuation">,</span> constructorArgTypes<span class="token punctuation">,</span> constructorArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">crateProxy</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">Callback</span> callback<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> constructorArgTypes<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> constructorArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ›å»ºçš„ä»£ç†æ˜¯åŸå¯¹è±¡çš„å­ç±»</span>
    enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// è·å–ç±»ä¸­çš„writeReplace</span>
      type<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token constant">WRITE_REPLACE_METHOD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ObjectOutputStream will call writeReplace of objects returned by writeReplace</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">LogHolder</span><span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LogHolder</span><span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token constant">WRITE_REPLACE_METHOD</span> <span class="token operator">+</span> <span class="token string">&quot; method was found on bean &quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot;, make sure it returns this&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ²¡æœ‰æ‰¾åˆ°åˆ™åˆ™è®¾ç½®ä»£ç†ç±»å»ç»§æ‰¿WriteReplaceInterfaceæ¥å£</span>
      enhancer<span class="token punctuation">.</span><span class="token function">setInterfaces</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token class-name">WriteReplaceInterface</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// nothing to do here</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Object</span> enhanced<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>constructorArgTypes<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      enhanced <span class="token operator">=</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> typesArray <span class="token operator">=</span> constructorArgTypes<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span>constructorArgTypes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valuesArray <span class="token operator">=</span> constructorArgs<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>constructorArgs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      enhanced <span class="token operator">=</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>typesArray<span class="token punctuation">,</span> valuesArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> enhanced<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»ºä»£ç†ç±»ä¹‹ååœ¨ä»£ç ä¸­çš„get/setæ–¹æ³•éƒ½æ˜¯è¯·æ±‚çš„ä»£ç†ç±»çš„interceptæ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EnhancedResultObjectProxyImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span> <span class="token punctuation">{</span>

    <span class="token comment">// è¢«ä»£ç†ç±»</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">;</span>
    <span class="token comment">// éœ€è¦æ‡’åŠ è½½çš„å±æ€§map</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ResultLoaderMap</span> lazyLoader<span class="token punctuation">;</span>
    <span class="token comment">// æ˜¯å¦æ˜¯æ¿€è¿›æ‡’åŠ è½½</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> aggressive<span class="token punctuation">;</span>
    <span class="token comment">// èƒ½å¤Ÿè§¦å‘å…¨å±€æ‡’åŠ è½½çš„æ–¹æ³•å</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> lazyLoadTriggerMethods<span class="token punctuation">;</span>
    <span class="token comment">// å¯¹è±¡å·¥å‚</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectFactory</span> objectFactory<span class="token punctuation">;</span>
    <span class="token comment">// è¢«ä»£ç†ç±»æ„é€ å‡½æ•°çš„å‚æ•°åˆ—è¡¨ç±»å‹</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> constructorArgTypes<span class="token punctuation">;</span>
    <span class="token comment">// è¢«ä»£ç†ç±»æ„é€ å‡½æ•°çš„å‚æ•°åˆ—è¡¨</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> constructorArgs<span class="token punctuation">;</span>
    
    <span class="token comment">// ä»£ç†ç±»çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶éƒ½ä¼šè¿›è¿™ä¸ªæ–¹æ³•</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> enhanced<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> <span class="token class-name">String</span> methodName <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// é˜²æ­¢å¹¶å‘åŠ è½½</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lazyLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// è°ƒç”¨writeReplace</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">WRITE_REPLACE_METHOD</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// åˆ›å»ºåŸå§‹å¯¹è±¡</span>
            <span class="token class-name">Object</span> original<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>constructorArgTypes<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              original <span class="token operator">=</span> objectFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              original <span class="token operator">=</span> objectFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> constructorArgTypes<span class="token punctuation">,</span> constructorArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// å°†ä¹‹å‰å¯¹è±¡çš„å±æ€§æ‹·è´åˆ°æ–°çš„å¯¹è±¡</span>
            <span class="token class-name">PropertyCopier</span><span class="token punctuation">.</span><span class="token function">copyBeanProperties</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> enhanced<span class="token punctuation">,</span> original<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å­˜åœ¨æ‡’åŠ è½½å±æ€§é€šè¿‡CglibSerialStateHolderå°è£…æ•°æ®</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lazyLoader<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CglibSerialStateHolder</span><span class="token punctuation">(</span>original<span class="token punctuation">,</span> lazyLoader<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objectFactory<span class="token punctuation">,</span> constructorArgTypes<span class="token punctuation">,</span> constructorArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// ç›´æ¥è¿”å›åŸå¯¹è±¡è¿›è¡Œåºåˆ—åŒ–</span>
              <span class="token keyword">return</span> original<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// å­˜åœ¨æ‡’åŠ è½½å±æ€§ï¼Œå¹¶ä¸”ä¸æ˜¯çš„è°ƒç”¨finalizeæ–¹æ³•</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lazyLoader<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token constant">FINALIZE_METHOD</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// è®¾ç½®äº†æ¿€è¿›åŠ è½½æˆ–è€…è°ƒç”¨äº†èƒ½å¤Ÿè§¦å‘å…¨å±€åŠ è½½çš„æ–¹æ³•</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>aggressive <span class="token operator">||</span> lazyLoadTriggerMethods<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å®Œæˆæ‰€æœ‰å±æ€§çš„æ‡’åŠ è½½</span>
                lazyLoader<span class="token punctuation">.</span><span class="token function">loadAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token comment">// è°ƒç”¨äº†å±æ€§å†™æ–¹æ³•</span>
              <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PropertyNamer</span><span class="token punctuation">.</span><span class="token function">isSetter</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ¸…é™¤å±æ€§çš„æ‡’åŠ è½½è®¾ç½®ï¼Œåé¢å°±ä¸éœ€è¦æ‡’åŠ è½½äº†</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> property <span class="token operator">=</span> <span class="token class-name">PropertyNamer</span><span class="token punctuation">.</span><span class="token function">methodToProperty</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                lazyLoader<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token comment">// è°ƒç”¨äº†å±æ€§è·å–æ¥å£</span>
              <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PropertyNamer</span><span class="token punctuation">.</span><span class="token function">isGetter</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> property <span class="token operator">=</span> <span class="token class-name">PropertyNamer</span><span class="token punctuation">.</span><span class="token function">methodToProperty</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lazyLoader<span class="token punctuation">.</span><span class="token function">hasLoader</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment">// å¦‚æœå±æ€§æ²¡æœ‰è¿›è¡Œæ‡’åŠ è½½åˆ™è¿›è¡Œæ‡’åŠ è½½</span>
                  lazyLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è§¦å‘è¢«ä»£ç†çš„ç›¸åº”æ–¹æ³•</span>
        <span class="token keyword">return</span> methodProxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>enhanced<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-5-3-parameterå­åŒ…" tabindex="-1"><a class="header-anchor" href="#_1-5-3-parameterå­åŒ…" aria-hidden="true">#</a> 1.5.3 parameterå­åŒ…</h4><p>åŒ…é‡Œé¢åªæœ‰ä¸€ä¸ªæ¥å£ï¼Œä¸»è¦æ˜¯ç»™sqlè¯­å¥ä¸­çš„å‚æ•°èµ‹å€¼ã€‚å®ç°ç±»åœ¨scripting.defaultsé‡Œé¢ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ParameterHandler</span> <span class="token punctuation">{</span>

  <span class="token comment">// è·å–sqlå‚æ•°çš„å®ä½“å¯¹è±¡</span>
  <span class="token class-name">Object</span> <span class="token function">getParameterObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// sqlè¯­å¥ä¸­çš„å˜é‡èµ‹å€¼</span>
  <span class="token keyword">void</span> <span class="token function">setParameters</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> ps<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultParameterHandler</span> <span class="token keyword">implements</span> <span class="token class-name">ParameterHandler</span> <span class="token punctuation">{</span>

  <span class="token comment">// ç±»å‹å¤„ç†å™¨æ³¨å†Œè¡¨</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TypeHandlerRegistry</span> typeHandlerRegistry<span class="token punctuation">;</span>
  <span class="token comment">// MappedStatementåŒ…å«å®Œæ•´çš„å¢åˆ æ”¹æŸ¥èŠ‚ç‚¹ä¿¡æ¯</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MappedStatement</span> mappedStatement<span class="token punctuation">;</span>
  <span class="token comment">// å‚æ•°å¯¹è±¡</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> parameterObject<span class="token punctuation">;</span>
  <span class="token comment">// BoundSql åŒ…å«sqlã€å‚æ•°ã€å®å‚å¯¹è±¡</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Configuration</span> configuration<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setParameters</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> ps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activity</span><span class="token punctuation">(</span><span class="token string">&quot;setting parameters&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>mappedStatement<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–å‚æ•°åˆ—è¡¨</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ParameterMapping</span><span class="token punctuation">&gt;</span></span> parameterMappings <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getParameterMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parameterMappings <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> parameterMappings<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ParameterMapping</span> parameterMapping <span class="token operator">=</span> parameterMappings<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¿½ç•¥ParameterMode.OUT</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parameterMapping<span class="token punctuation">.</span><span class="token function">getMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">ParameterMode</span><span class="token punctuation">.</span><span class="token constant">OUT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">Object</span> value<span class="token punctuation">;</span>
          <span class="token comment">// å–å‡ºå±æ€§åç§°</span>
          <span class="token class-name">String</span> propertyName <span class="token operator">=</span> parameterMapping<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// å­˜åœ¨å‚æ•°åˆ™ä»é™„åŠ å‚æ•°ä¸­è·å–</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>boundSql<span class="token punctuation">.</span><span class="token function">hasAdditionalParameter</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// issue #448 ask first for additional params</span>
            value <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getAdditionalParameter</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>parameterObject <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// å‚æ•°ç±»å‹æ˜¯åŸºæœ¬ç±»å‹åˆ™å‚æ•°å¯¹è±¡å°±æ˜¯å‚æ•°å€¼</span>
          <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>typeHandlerRegistry<span class="token punctuation">.</span><span class="token function">hasTypeHandler</span><span class="token punctuation">(</span>parameterObject<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            value <span class="token operator">=</span> parameterObject<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// å¤æ‚å¯¹è±¡åˆ™å–å‡ºå¯¹è±¡çš„å±æ€§å€¼</span>
          <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">MetaObject</span> metaObject <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">newMetaObject</span><span class="token punctuation">(</span>parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> metaObject<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// ç¡®è®¤å‚æ•°çš„å¤„ç†å™¨</span>
          <span class="token class-name">TypeHandler</span> typeHandler <span class="token operator">=</span> parameterMapping<span class="token punctuation">.</span><span class="token function">getTypeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name">JdbcType</span> jdbcType <span class="token operator">=</span> parameterMapping<span class="token punctuation">.</span><span class="token function">getJdbcType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> jdbcType <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jdbcType <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getJdbcTypeForNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// é€šè¿‡å‚æ•°ç±»å‹ç»™å‚æ•°èµ‹å€¼</span>
            typeHandler<span class="token punctuation">.</span><span class="token function">setParameter</span><span class="token punctuation">(</span>ps<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> jdbcType<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TypeException</span> <span class="token operator">|</span> <span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not set parameters for mapping: &quot;</span> <span class="token operator">+</span> parameterMapping <span class="token operator">+</span> <span class="token string">&quot;. Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-5-4-resultå­åŒ…" tabindex="-1"><a class="header-anchor" href="#_1-5-4-resultå­åŒ…" aria-hidden="true">#</a> 1.5.4 resultå­åŒ…</h4><p>åŠŸèƒ½ä¸»è¦æ˜¯å¤„ç†ç»“æœä¸­çš„åµŒå¥—æ˜ å°„ã€æ ¹æ®æ˜ å°„å…³ç³»ç”Ÿæˆç»“æœå¯¹è±¡ã€æ ¹æ®æ•°æ®åº“æŸ¥è¯¢çš„æ¥å£å¯¹å¯¹è±¡ç»“æœèµ‹å€¼ã€å°†ç»“æœå¯¹è±¡æ±‡æ€»List Map Cursorç­‰ã€‚è¿™ä¸ªå­åŒ…è´Ÿè´£å°†ç»“æœå¯¹è±¡æ±‡æ€»ä¸ºListæˆ–è€…Mapï¼Œå…¶ä»–çš„åœ¨resultSetå­åŒ…é‡Œé¢å¤„ç†</p><p>æ±‡æ€»ä¸ºListçš„DefaultResultHandlerã€æ±‡æ€»ä¸ºmapçš„DefaultMapResultHandlerã€DefaultResultContextå•ç‹¬å­˜å‚¨ä¸€æ¡æ•°æ®åº“ç»“æœã€‚æºç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ç»“æœä¸Šä¸‹æ–‡ å­˜æ”¾æ•°æ®åº“ä¸­çš„ä¸€æ¡æ•°æ®</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultResultContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ResultContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

  <span class="token comment">// ç»“æœå¯¹è±¡</span>
  <span class="token keyword">private</span> <span class="token class-name">T</span> resultObject<span class="token punctuation">;</span>
  <span class="token comment">// ç»“æœè®¡æ•°</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> resultCount<span class="token punctuation">;</span>
  <span class="token comment">// ä½¿ç”¨å®Œæ¯•</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> stopped<span class="token punctuation">;</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>  

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultMapResultHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ResultHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

  <span class="token comment">// mapå½¢å¼çš„ç»“æœæ˜ å°„</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> mappedResults<span class="token punctuation">;</span>
  <span class="token comment">// ç»“æœå¯¹è±¡çš„æŸä¸ªå±æ€§å</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> mapKey<span class="token punctuation">;</span>
  <span class="token comment">// å¯¹è±¡å·¥å‚</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectFactory</span> objectFactory<span class="token punctuation">;</span>
  <span class="token comment">// å¯¹è±¡åŒ…è£…å·¥å‚</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectWrapperFactory</span> objectWrapperFactory<span class="token punctuation">;</span>
  <span class="token comment">// åå°„å·¥å‚</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReflectorFactory</span> reflectorFactory<span class="token punctuation">;</span>

  <span class="token comment">// æˆ–è€…ç»“æœä¸ºmap</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleResult</span><span class="token punctuation">(</span><span class="token class-name">ResultContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–å¯¹è±¡çš„æºå¯¹è±¡</span>
    <span class="token keyword">final</span> <span class="token class-name">V</span> value <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResultObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">MetaObject</span> mo <span class="token operator">=</span> <span class="token class-name">MetaObject</span><span class="token punctuation">.</span><span class="token function">forObject</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> objectFactory<span class="token punctuation">,</span> objectWrapperFactory<span class="token punctuation">,</span> reflectorFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO is that assignment always true?</span>
    <span class="token comment">// putåˆ°mapé‡Œé¢</span>
    <span class="token keyword">final</span> <span class="token class-name">K</span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">K</span><span class="token punctuation">)</span> mo<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>mapKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mappedResults<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-5-5-resultsetå­åŒ…" tabindex="-1"><a class="header-anchor" href="#_1-5-5-resultsetå­åŒ…" aria-hidden="true">#</a> 1.5.5 resultSetå­åŒ…</h4><p>ä¸»è¦è¿›è¡Œå¤„ç†ç»“æœä¸­çš„åµŒå¥—æ˜ å°„ã€æ ¹æ®æ˜ å°„å…³ç³»ç”Ÿæˆç»“æœå¯¹è±¡ã€æ ¹æ®æ•°æ®åº“æŸ¥è¯¢çš„æ¥å£å¯¹å¯¹è±¡ç»“æœèµ‹å€¼ã€‚åŒ…é‡Œé¢ä¸€å…±æœ‰3ä¸ªç±»ResultSetHandleræ¥å£ã€å®ç°ç±»DefaultResultSetHandlerã€åŒ…è£…å™¨ç±»ResultSetWrapperï¼ˆåŒ…è£…ResultSetï¼‰ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ResultSetå¤„ç†å™¨</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ResultSetHandler</span> <span class="token punctuation">{</span>

  <span class="token comment">// å¤„ç†ResultSetä¸ºList</span>
  <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleResultSets</span><span class="token punctuation">(</span><span class="token class-name">Statement</span> stmt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>

  <span class="token comment">// å¤„ç†æ¸¸æ ‡ResultSetä¸ºCursor</span>
  <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Cursor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleCursorResultSets</span><span class="token punctuation">(</span><span class="token class-name">Statement</span> stmt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>

  <span class="token comment">// å­˜å‚¨è¿‡ç¨‹çš„è¾“å‡ºç»“æœ</span>
  <span class="token keyword">void</span> <span class="token function">handleOutputParameters</span><span class="token punctuation">(</span><span class="token class-name">CallableStatement</span> cs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">// åŒ…è£…ç±»æä¾›äº†ä¸€äº›ç»“æœé›†çš„å¸¸ç”¨æ–¹æ³•</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResultSetWrapper</span> <span class="token punctuation">{</span>

  <span class="token comment">// è¢«è£…é¥°çš„ResultSetå¯¹è±¡</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ResultSet</span> resultSet<span class="token punctuation">;</span>
  <span class="token comment">// ç±»å‹å¤„ç†å™¨æ³¨å†Œè¡¨</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TypeHandlerRegistry</span> typeHandlerRegistry<span class="token punctuation">;</span>
  <span class="token comment">// åˆ—åé›†åˆ</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> columnNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ç±»åé›†åˆ</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> classNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// jdbcç±»å‹é›†åˆ</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JdbcType</span><span class="token punctuation">&gt;</span></span> jdbcTypes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ç±»å‹ä¸ç±»å‹å¤„ç†å™¨map Map&lt;åˆ—å, Map&lt;javaç±»å‹, ç±»å‹å¤„ç†å™¨&gt;&gt;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">TypeHandler</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> typeHandlerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ‰€æœ‰æœ‰å…³ç³»æ˜ å°„åˆ—å Map&lt;resultMapçš„ID, List&lt;åˆ—å&gt;&gt;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mappedColumnNamesMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ²¡æœ‰å…³ç³»æ˜ å°„åˆ—å</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> unMappedColumnNamesMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-5-6-statementå­åŒ…" tabindex="-1"><a class="header-anchor" href="#_1-5-6-statementå­åŒ…" aria-hidden="true">#</a> 1.5.6 statementå­åŒ…</h4><p>è´Ÿè´£æä¾›è¯­å¥å¤„ç†èƒ½åŠ›,ä¸€å…±æœ‰ä¸€ä¸ªæ¥å£5ä¸ªå®ç°ç±»</p><p><img src="https://gaoqisen.github.io/GraphBed/202108/20210812140021.png" alt="statement"></p><p>è·¯ç”±è¯­å¥å¤„ç†å™¨æ˜¯é€šè¿‡è¯­å¥ç±»å‹è¿›è¡Œ3ä¸ªå…·ä½“å®ç°ç±»çš„è½¬å‘åŠŸèƒ½ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoutingStatementHandler</span> <span class="token keyword">implements</span> <span class="token class-name">StatementHandler</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StatementHandler</span> delegate<span class="token punctuation">;</span>

  <span class="token comment">// æ ¹æ®è¯­å¥ç±»å‹è·¯ç”±åˆ°ä¸åŒçš„è¯­å¥å¤„ç†å®ç°</span>
  <span class="token keyword">public</span> <span class="token class-name">RoutingStatementHandler</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">,</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getStatementType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ç›´æ¥æ“ä½œsqlï¼Œä¸è¿›è¡Œé¢„ç¼–è¯‘ï¼Œè·å–æ•°æ®ï¼š$â€”Statement</span>
      <span class="token keyword">case</span> <span class="token constant">STATEMENT</span><span class="token operator">:</span>
        delegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStatementHandler</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> ms<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">// é¢„å¤„ç†ï¼Œå‚æ•°ï¼Œè¿›è¡Œé¢„ç¼–è¯‘ï¼Œè·å–æ•°æ®ï¼š#â€”â€“PreparedStatement:é»˜è®¤</span>
      <span class="token keyword">case</span> <span class="token constant">PREPARED</span><span class="token operator">:</span>
        delegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PreparedStatementHandler</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> ms<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">// æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹â€”â€”â€”â€”CallableStatement</span>
      <span class="token keyword">case</span> <span class="token constant">CALLABLE</span><span class="token operator">:</span>
        delegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CallableStatementHandler</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> ms<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutorException</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown statement type: &quot;</span> <span class="token operator">+</span> ms<span class="token punctuation">.</span><span class="token function">getStatementType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ... å…¶ä»–æ–¹æ³•éƒ½æ˜¯è¿›è¡Œçš„è½¬å‘</span>
<span class="token punctuation">}</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3ä¸ªå…·ä½“çš„å®ç°ç±»é€»è¾‘éƒ½å·®ä¸å¤šï¼ŒPreparedStatementHandlerçš„æºç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PreparedStatementHandler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseStatementHandler</span> <span class="token punctuation">{</span>

  <span class="token keyword">public</span> <span class="token class-name">PreparedStatementHandler</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">MappedStatement</span> mappedStatement<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">,</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> mappedStatement<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Statement</span> statement<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">PreparedStatement</span> ps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span><span class="token punctuation">)</span> statement<span class="token punctuation">;</span>
    ps<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> rows <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token function">getUpdateCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ•°æ®æ’å…¥åè¿›è¡Œçš„KeyGeneratoræ“ä½œ</span>
    <span class="token class-name">Object</span> parameterObject <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getParameterObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">KeyGenerator</span> keyGenerator <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getKeyGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    keyGenerator<span class="token punctuation">.</span><span class="token function">processAfter</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> mappedStatement<span class="token punctuation">,</span> ps<span class="token punctuation">,</span> parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rows<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batch</span><span class="token punctuation">(</span><span class="token class-name">Statement</span> statement<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">PreparedStatement</span> ps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span><span class="token punctuation">)</span> statement<span class="token punctuation">;</span>
    ps<span class="token punctuation">.</span><span class="token function">addBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Statement</span> statement<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token comment">// jdbcå£°æ˜æ‰§è¡Œ</span>
    <span class="token class-name">PreparedStatement</span> ps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span><span class="token punctuation">)</span> statement<span class="token punctuation">;</span>
    ps<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¤„ç†ç»“æœé›†</span>
    <span class="token keyword">return</span> resultSetHandler<span class="token punctuation">.</span><span class="token function">handleResultSets</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Cursor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCursor</span><span class="token punctuation">(</span><span class="token class-name">Statement</span> statement<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">PreparedStatement</span> ps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span><span class="token punctuation">)</span> statement<span class="token punctuation">;</span>
    ps<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> resultSetHandler<span class="token punctuation">.</span><span class="token function">handleCursorResultSets</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å®ä¾‹åŒ–è¯­å¥</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token class-name">Statement</span> <span class="token function">instantiateStatement</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedStatement<span class="token punctuation">.</span><span class="token function">getKeyGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">Jdbc3KeyGenerator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyColumnNames <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getKeyColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>keyColumnNames <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token class-name">PreparedStatement</span><span class="token punctuation">.</span><span class="token constant">RETURN_GENERATED_KEYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> keyColumnNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedStatement<span class="token punctuation">.</span><span class="token function">getResultSetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResultSetType</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getResultSetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ResultSet</span><span class="token punctuation">.</span><span class="token constant">CONCUR_READ_ONLY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parameterize</span><span class="token punctuation">(</span><span class="token class-name">Statement</span> statement<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    parameterHandler<span class="token punctuation">.</span><span class="token function">setParameters</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span><span class="token punctuation">)</span> statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-5-7-æ‰§è¡Œå™¨æ ¸å¿ƒç±»" tabindex="-1"><a class="header-anchor" href="#_1-5-7-æ‰§è¡Œå™¨æ ¸å¿ƒç±»" aria-hidden="true">#</a> 1.5.7 æ‰§è¡Œå™¨æ ¸å¿ƒç±»</h4><p><img src="https://gaoqisen.github.io/GraphBed/202108/20210812160834.png" alt="executer"></p><p>Executoræ‰§è¡Œå™¨å­˜åœ¨å¤šä¸ªå®ç°ç±»ã€‚CachingExecutorä¸»è¦çš„å·¥ä½œå°±æ˜¯æ·»åŠ ç¼“å­˜ï¼ŒBaseExecutoræ‰§è¡Œå™¨å……å½“æ¨¡ç‰ˆæ–¹æ³•å°†é€šç”¨çš„é€»è¾‘éƒ½æ”¾åœ¨è¿™é‡Œæ‰§è¡Œå…¶ä»–çš„å­ç±»å®ç°äº†BaseExecutorè¿›è¡Œä¸€äº›statementçš„åˆ›å»ºå’Œå‚æ•°çš„ç»‘å®šç­‰å·¥ä½œã€‚ä¸‹é¢ç»™å‡ºBaseExecutorçš„ä¸€äº›ä»£ç ç‰‡æ®µ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ä½œç”¨äºsqlSessionï¼ˆæ¨¡ç‰ˆæ–¹æ³•çš„ä½œç”¨ï¼‰</span>
<span class="token comment">// å®ƒçš„å­ç±»ä¸»è¦çš„å·¥ä½œå°±æ˜¯å®Œæˆstatementå¯¹è±¡çš„åˆ›å»ºã€å‚æ•°ç»‘å®šç­‰</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">Executor</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> log <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">BaseExecutor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">protected</span> <span class="token class-name">Transaction</span> transaction<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token class-name">Executor</span> wrapper<span class="token punctuation">;</span>

  <span class="token keyword">protected</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeferredLoad</span><span class="token punctuation">&gt;</span></span> deferredLoads<span class="token punctuation">;</span>
  <span class="token comment">// ä¸€çº§ç¼“å­˜ï¼ˆæŸ¥è¯¢æ“ä½œçš„ç»“æœç¼“å­˜ï¼‰</span>
  <span class="token comment">// åœ¨è¡¨ç¤ºä¼šè¯çš„SqlSessionå¯¹è±¡ä¸­å»ºç«‹ä¸€ä¸ªç®€å•çš„ç¼“å­˜ï¼Œå°†æ¯æ¬¡æŸ¥è¯¢åˆ°çš„ç»“æœç»“æœç¼“å­˜èµ·æ¥ï¼Œå½“ä¸‹æ¬¡æŸ¥è¯¢çš„æ—¶å€™ï¼Œ</span>
  <span class="token comment">// å¦‚æœåˆ¤æ–­å…ˆå‰æœ‰ä¸ªå®Œå…¨ä¸€æ ·çš„æŸ¥è¯¢ï¼Œä¼šç›´æ¥ä»ç¼“å­˜ä¸­ç›´æ¥å°†ç»“æœå–å‡ºï¼Œè¿”å›ç»™ç”¨æˆ·ï¼Œä¸éœ€è¦å†è¿›è¡Œä¸€æ¬¡æ•°æ®åº“æŸ¥è¯¢äº†</span>
  <span class="token keyword">protected</span> <span class="token class-name">PerpetualCache</span> localCache<span class="token punctuation">;</span>
  <span class="token comment">// callableæŸ¥è¯¢çš„è¾“å‡ºå‚æ•°ç¼“å­˜</span>
  <span class="token keyword">protected</span> <span class="token class-name">PerpetualCache</span> localOutputParameterCache<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token class-name">Configuration</span> configuration<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">,</span> <span class="token class-name">CacheKey</span> key<span class="token punctuation">,</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activity</span><span class="token punctuation">(</span><span class="token string">&quot;executing a query&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ‰§è¡Œå™¨å·²ç»å…³é—­</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutorException</span><span class="token punctuation">(</span><span class="token string">&quot;Executor was closed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ–°çš„æŸ¥è¯¢æ ˆä¸”è¦æ±‚é‡å¯</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>queryStack <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ms<span class="token punctuation">.</span><span class="token function">isFlushCacheRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ¸…é™¤ä¸€çº§ç¼“å­˜</span>
      <span class="token function">clearLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      queryStack<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token comment">// å°è¯•æœ¬åœ°ç¼“å­˜è·å–ç»“æœ</span>
      list <span class="token operator">=</span> resultHandler <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> localCache<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æœ¬åœ°ç¼“å­˜ä¸­å­˜åœ¨ç»“æœ, å¦‚æœæ˜¯CALLABLEè¯­å¥åˆ™ç»‘å®šå‚æ•°</span>
        <span class="token function">handleLocallyCachedOutputParameters</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> key<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ç¼“å­˜ä¸ºç©ºåˆ™ä»æ•°æ®åº“æ‰§è¡Œsqlï¼ˆä»æ•°æ®åº“è¿›è¡ŒæŸ¥è¯¢æ“ä½œå‰çš„æœ¬åœ°ç¼“å­˜å¤„ç†ï¼Œä¹‹åè°ƒç”¨æŠ½è±¡æ–¹æ³•doQueryï¼‰</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        list <span class="token operator">=</span> <span class="token function">queryFromDatabase</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> key<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      queryStack<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>queryStack <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å»¶è¿ŸåŠ è½½å¤„ç†</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DeferredLoad</span> deferredLoad <span class="token operator">:</span> deferredLoads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        deferredLoad<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// issue #601</span>
      deferredLoads<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// å¦‚æœæœ¬åœ°ç¼“å­˜çš„ä½œç”¨åŸŸæ˜¯STATEMENTåˆ™æ¸…ç†ç¼“å­˜</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">getLocalCacheScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">LocalCacheScope</span><span class="token punctuation">.</span><span class="token constant">STATEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// issue #482</span>
        <span class="token function">clearLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ›´æ–°æ•°æ®åº“æ•°æ® insert/update/deleteéƒ½è°ƒç”¨æ­¤æ–¹æ³•</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token comment">// æ›´æ–°æ“ä½œçš„å‚æ•°æ¯”è¾ƒç®€å•ï¼ŒæŸ¥è¯¢ç»“æœçš„è¾“å‡ºä¹Ÿæ˜¯æ¯”è¾ƒå¤æ‚çš„</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activity</span><span class="token punctuation">(</span><span class="token string">&quot;executing an update&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ‰§è¡Œå™¨å·²ç»å…³é—­</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutorException</span><span class="token punctuation">(</span><span class="token string">&quot;Executor was closed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ¸…ç†ç¼“å­˜</span>
    <span class="token function">clearLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿”å›è°ƒç”¨å­ç±»è¿›è¡Œæ“ä½œ</span>
    <span class="token keyword">return</span> <span class="token function">doUpdate</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-6-sessionåŒ…" tabindex="-1"><a class="header-anchor" href="#_1-6-sessionåŒ…" aria-hidden="true">#</a> 1.6 sessionåŒ…</h3><p>è¿™ä¸ªåŒ…é‡Œé¢å­˜åœ¨SqlSessionFactoryBuilderç”Ÿäº§äº†SqlSessionFactoryï¼ŒSqlSessionFactoryç”Ÿæˆäº†SqlSessionä»¥åŠä¸¤ä¸ªæ¥å£ï¼Œä¹‹åå°±æ˜¯ä¸€äº›æšä¸¾ç±»ã€ Configuationã€SqlSessionManager(æä¾›äº†å¤ç”¨åŠŸèƒ½)ã€‚</p><p>SqlSessionFactoryBuilderç±»çš„ä¸»è¦é€»è¾‘å°±æ˜¯å»è§£æxmlæŠ¥æ–‡ï¼Œå¹¶åˆ›å»ºsqlSessionFactoryï¼Œæºç å¦‚ä¸‹:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">,</span> <span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// Xmlé…ç½®æ„å»º</span>
      <span class="token class-name">XMLConfigBuilder</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLConfigBuilder</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// å°†mybatis-config.xmlæ–‡ä»¶è§£æä¸ºDocumentåï¼Œåœ¨è§£æä¸ºConfigurationå¯¹è±¡</span>
      <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token class-name">ExceptionFactory</span><span class="token punctuation">.</span><span class="token function">wrapException</span><span class="token punctuation">(</span><span class="token string">&quot;Error building SqlSession.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Intentionally ignore. Prefer previous error.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// æ„å»ºé»˜è®¤çš„SqlSessionFactory</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSqlSessionFactory</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>sqlSessionFactoryé‡Œé¢ä¸»è¦æ˜¯é€šè¿‡é…ç½®ä¿¡æ¯è·å–ç¯å¢ƒæ•°æ®åˆ›å»ºæ‰§è¡Œå™¨ä¹‹åç”Ÿæˆäº†sqlSession</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token class-name">SqlSession</span> <span class="token function">openSessionFromDataSource</span><span class="token punctuation">(</span><span class="token class-name">ExecutorType</span> execType<span class="token punctuation">,</span> <span class="token class-name">TransactionIsolationLevel</span> level<span class="token punctuation">,</span> <span class="token keyword">boolean</span> autoCommit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Transaction</span> tx <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// é€šè¿‡é…ç½®æ¶ˆæ¯è·å–äº‹åŠ¡</span>
      <span class="token keyword">final</span> <span class="token class-name">Environment</span> environment <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token class-name">TransactionFactory</span> transactionFactory <span class="token operator">=</span> <span class="token function">getTransactionFactoryFromEnvironment</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
      tx <span class="token operator">=</span> transactionFactory<span class="token punctuation">.</span><span class="token function">newTransaction</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> level<span class="token punctuation">,</span> autoCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// é€šè¿‡ç¯å¢ƒä¿¡æ¯å’Œäº‹åŠ¡è·å–æ‰§è¡Œå™¨</span>
      <span class="token keyword">final</span> <span class="token class-name">Executor</span> executor <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">newExecutor</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> execType<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// åˆå§‹åŒ–ä¸€ä¸ªDefaultSqlSession</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSqlSession</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> autoCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">closeTransaction</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// may have fetched a connection so lets call close()</span>
      <span class="token keyword">throw</span> <span class="token class-name">ExceptionFactory</span><span class="token punctuation">.</span><span class="token function">wrapException</span><span class="token punctuation">(</span><span class="token string">&quot;Error opening session.  Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>sqlSessioné‡Œé¢å°±æ˜¯å»è°ƒç”¨å…·ä½“çš„æ‰§è¡Œå™¨æ–¹æ³•å»æ‰§è¡Œå„è‡ªçš„é€»è¾‘</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token comment">// æ‰§è¡ŒselectList</span>
  <span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">String</span> statement<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// è·å–æ˜ å°„å£°æ˜</span>
      <span class="token class-name">MappedStatement</span> ms <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getMappedStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// äº¤ç»™æ‰§è¡Œå™¨å»æ‰§è¡ŒæŸ¥è¯¢è¯­å¥</span>
      <span class="token keyword">return</span> executor<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> <span class="token function">wrapCollection</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token class-name">ExceptionFactory</span><span class="token punctuation">.</span><span class="token function">wrapException</span><span class="token punctuation">(</span><span class="token string">&quot;Error querying database.  Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>sqlSessionManageråŒæ—¶ç»§æ‰¿äº†sqlSessionå’ŒsqlSessionFactoryä¸¤ä¸ªç±»ï¼Œæä¾›äº†äº§å“å¤ç”¨çš„åŠŸèƒ½ï¼ˆä¿è¯äº†çº¿ç¨‹å®‰å…¨ä¹Ÿæé«˜äº†æ•ˆç‡ï¼‰ï¼Œèƒ½å¿½ç•¥ç”Ÿäº§äº§å“çš„è¿‡ç¨‹ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlSessionManager</span> <span class="token keyword">implements</span> <span class="token class-name">SqlSessionFactory</span><span class="token punctuation">,</span> <span class="token class-name">SqlSession</span> <span class="token punctuation">{</span>

  <span class="token comment">// sqlSessionå·¥å‚</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SqlSessionFactory</span> sqlSessionFactory<span class="token punctuation">;</span>
  <span class="token comment">// ä»£ç†sqlSeesion</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SqlSession</span> sqlSessionProxy<span class="token punctuation">;</span>
  <span class="token comment">// å­˜å‚¨è¢«ä»£ç†çš„sqlSession</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SqlSession</span><span class="token punctuation">&gt;</span></span> localSqlSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// åˆ›å»ºSqlSessionçš„ä»£ç†ç±»</span>
  <span class="token keyword">private</span> <span class="token class-name">SqlSessionManager</span><span class="token punctuation">(</span><span class="token class-name">SqlSessionFactory</span> sqlSessionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactory <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionProxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>
        <span class="token class-name">SqlSessionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">SqlSession</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">SqlSessionInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// sqlSessionæ‹¦æˆªå™¨</span>
  <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">SqlSessionInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">SqlSessionInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Prevent Synthetic Access</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
      <span class="token comment">// è·å–å½“å‰çº¿ç¨‹ï¼ˆThreadLocalï¼‰ä¸­çš„sqlSessionå¯¹è±¡</span>
      <span class="token keyword">final</span> <span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> <span class="token class-name">SqlSessionManager</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>localSqlSession<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// å­˜åœ¨sqlSessionå¯¹è±¡åˆ™ä½¿ç”¨å­˜åœ¨çš„SqlSessionå¯¹è±¡å»å¤„ç†</span>
          <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸å­˜åœ¨åˆ™ä»sqlå·¥å‚ä¸­åˆ›å»ºä¸€ä¸ªsqlSessionå¯¹è±¡</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span> autoSqlSession <span class="token operator">=</span> <span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// è°ƒç”¨æ–¹æ³•å¹¶è¿›è¡Œäº‹åŠ¡æäº¤</span>
            <span class="token keyword">final</span> <span class="token class-name">Object</span> result <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>autoSqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            autoSqlSession<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// äº‹åŠ¡å›æ»š</span>
            autoSqlSession<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹‹åå°±æ˜¯ä¸€äº›æšä¸¾ç±»AutoMappingBehaviorè‡ªåŠ¨æ˜ å°„è¡Œä¸ºï¼ˆä¸æ˜ å°„ã€ä»…å•å±‚æ˜ å°„ã€å…¨éƒ¨æ˜ å°„ï¼‰ã€AutoMappingUnknownColumnBehaviorè‡ªåŠ¨æ˜ å°„æœªçŸ¥è¡Œä¸ºï¼ˆä¸å¤„ç†ã€è¾“å‡ºå‘Šè­¦æ—¥å¿—ã€æŠ›å‡ºå¼‚å¸¸ï¼‰ã€ExecutorTypeæ‰§è¡Œå™¨ç±»å‹ï¼ˆç®€å•ã€å¤ç”¨ã€æ‰¹é‡ï¼‰ã€LocalCachSpaceæœ¬åœ°ç¼“å­˜èŒƒå›´ï¼ˆä¼šè¯ã€è¯­å¥ï¼‰ã€TransactionIsolationLeveläº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆæ— éš”ç¦»ã€è¯»å·²æäº¤ã€è¯»æœªæäº¤ã€å¯é‡å¤è¯»ã€å¯ä¸²è¡ŒåŒ–ï¼‰</p><h3 id="_1-7-pluginåŒ…" tabindex="-1"><a class="header-anchor" href="#_1-7-pluginåŒ…" aria-hidden="true">#</a> 1.7 pluginåŒ…</h3><p>ä¸ºäº†å®ç°è®©å…¶ä»–å¼€å‘è€…å¼€å‘æ’ä»¶å»æ‰©å±•mybatisã€‚å®ç°mybatisçš„Interceptoræ¥å£å³å¯è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚å®ç°åŸç†æ˜¯åœ¨æ‰§è¡Œè¯­å¥çš„æ—¶å€™ä¼šæŠŠæ’ä»¶æ‹¦æˆªå™¨åˆå§‹åŒ–åˆ°é“¾æ¡é‡Œé¢ï¼Œåˆå§‹åŒ–æ‰§è¡Œå™¨ï¼ˆåªæœ‰4ä¸ªç±»ä¼šè¿›è¡ŒåŒ…è£…ï¼‰çš„æ—¶å€™å»è¿›è¡ŒåŒ…è£…ï¼ˆåˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œæ‹¦æˆªï¼Œå¦‚æœéœ€è¦è¿›è¡Œæ‹¦æˆªåˆ™åˆ›å»ºä»£ç†ç±»ï¼‰è¿”å›ä»£ç†ç±»ï¼Œåœ¨æ‰§è¡Œä»£ç†ç±»çš„æ—¶å€™åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œæ‹¦æˆªï¼ˆå¦‚æœéœ€è¦åˆ™è°ƒç”¨æ‹¦æˆªå™¨çš„æ–¹æ³•è¿›è¡Œæ’ä»¶çš„é€»è¾‘å¤„ç†ï¼‰ã€‚</p><p>æ‹¦æˆªå™¨é“¾æ¡ä»£ç </p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterceptorChain</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Interceptor</span><span class="token punctuation">&gt;</span></span> interceptors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// åˆ›å»ºæ‰§è¡Œå™¨çš„æ—¶å€™å°†ç›®æ ‡ç±»æ”¾å…¥åˆ°æ‰€æœ‰çš„æ’ä»¶ä¸­å»åŒ…è£…ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªã€‚å¦‚æœéœ€è¦æ‹¦æˆªåˆ™åˆ›å»ºä»£ç†ç±»</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">pluginAll</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Interceptor</span> interceptor <span class="token operator">:</span> interceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      target <span class="token operator">=</span> interceptor<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// xmlè§£æçš„æ—¶å€™å°†æ‹¦æˆªå™¨åˆå§‹åŒ–åˆ°é“¾æ¡é‡Œé¢</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token class-name">Interceptor</span> interceptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Interceptor</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>interceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨xmlè§£æ(XMLConfigBuilder.pluginElement)çš„æ—¶å€™ä¼šè°ƒç”¨Interceptorçš„addInterceptoræ–¹æ³•å»åˆå§‹åŒ–æ‹¦æˆªå™¨</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pluginElement</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> parent<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">XNode</span> child <span class="token operator">:</span> parent<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> interceptor <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;interceptor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getChildrenAsProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ‹¦æˆªå™¨å®šä¹‰</span>
        <span class="token class-name">Interceptor</span> interceptorInstance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Interceptor</span><span class="token punctuation">)</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¾ç½®æ‹¦æˆªå™¨å±æ€§</span>
        interceptorInstance<span class="token punctuation">.</span><span class="token function">setProperties</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å°†æ‹¦æˆªå™¨æ”¾å…¥InterceptorChain</span>
        configuration<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>interceptorInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹‹åå°±æ˜¯åœ¨ç”Ÿæˆå¤„ç†å™¨çš„æ—¶å€™å»éå†æ‹¦æˆªå™¨é“¾æ¡ç”Ÿæˆä»£ç†ç±»ã€‚å¦‚ä¸‹é€»è¾‘ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token comment">// BatchExecutorç±»çš„doQueryæ–¹æ³•</span>
  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">doQuery</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameterObject<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">,</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Statement</span> stmt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">flushStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> ms<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// åˆ›å»ºè¯­å¥å¤„ç†å™¨ï¼ŒæŠŠå¤„ç†å™¨éå†æ‰€æœ‰çš„æ’ä»¶é“¾åˆ¤æ–­æ˜¯å¦éœ€è¦ç”Ÿæˆä»£ç†ç±»</span>
      <span class="token class-name">StatementHandler</span> handler <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">newStatementHandler</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> ms<span class="token punctuation">,</span> parameterObject<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token function">getConnection</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getStatementLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      stmt <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> transaction<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      handler<span class="token punctuation">.</span><span class="token function">parameterize</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// å¦‚æœæ˜¯ä»£ç†ç±»åˆ™æ‰§è¡Œä»£ç†ç±»ï¼Œå¦åˆ™æ‰§è¡ŒåŸæœ¬çš„å¤„ç†å™¨æ–¹æ³•</span>
      <span class="token keyword">return</span> handler<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> resultHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token function">closeStatement</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// åˆ›å»ºè¯­å¥å¤„ç†å™¨</span>
  <span class="token keyword">public</span> <span class="token class-name">StatementHandler</span> <span class="token function">newStatementHandler</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">MappedStatement</span> mappedStatement<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameterObject<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">,</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ›å»ºå¤„ç†å™¨</span>
    <span class="token class-name">StatementHandler</span> statementHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoutingStatementHandler</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> mappedStatement<span class="token punctuation">,</span> parameterObject<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// éå†æ‰€æœ‰æ’ä»¶åˆ¤æ–­æ˜¯å¦ç”Ÿæˆä»£ç†ç±»</span>
    statementHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StatementHandler</span><span class="token punctuation">)</span> interceptorChain<span class="token punctuation">.</span><span class="token function">pluginAll</span><span class="token punctuation">(</span>statementHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> statementHandler<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// éå†éœ€è¦æ‰§è¡Œçš„åŒ…è£…æ–¹æ³• åˆ¤æ–­æ–¹æ³•æ˜¯å¦éœ€è¦æ‹¦æˆªï¼Œå¦‚æœéœ€è¦æ‹¦æˆªåˆ™åˆ›å»ºä¸€ä¸ªä»£ç†ç±»</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token class-name">Interceptor</span> interceptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> signatureMap <span class="token operator">=</span> <span class="token function">getSignatureMap</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¢«ä»£ç†å¯¹è±¡çš„ç±»å‹</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æŸ¥æ‰¾çˆ¶ç±»ï¼ŒæŸ¥çœ‹æ˜¯å¦éœ€è¦æ‹¦æˆª</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces <span class="token operator">=</span> <span class="token function">getAllInterfaces</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> signatureMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>interfaces<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆ›å»ºä¸€ä¸ªPluginçš„ä»£ç†ç±»</span>
      <span class="token keyword">return</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>
          type<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          interfaces<span class="token punctuation">,</span>
          <span class="token keyword">new</span> <span class="token class-name">Plugin</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> interceptor<span class="token punctuation">,</span> signatureMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†å°±æ˜¯æ‰§è¡Œä»£ç†ç±»çš„invokeæ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ä»£ç†æ–¹æ³•</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆ¤æ–­æ–¹æ³•æ˜¯å¦éœ€è¦è¿›è¡Œæ‹¦æˆªå™¨æ–¹æ³•æ‰§è¡Œ</span>
      <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">&gt;</span></span> methods <span class="token operator">=</span> signatureMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>methods <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> methods<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> interceptor<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Invocation</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ä¸éœ€è¦åˆ™ç›´æ¥è°ƒç”¨è¢«ä»£ç†ç±»çš„æ–¹æ³•</span>
      <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="äºŒã€åŒ…ç»“æ„æ±‡æ€»" tabindex="-1"><a class="header-anchor" href="#äºŒã€åŒ…ç»“æ„æ±‡æ€»" aria-hidden="true">#</a> äºŒã€åŒ…ç»“æ„æ±‡æ€»</h2><table><thead><tr><th>åŒ…å</th><th>ä»‹ç»</th><th>è®¾è®¡æ¨¡å¼</th></tr></thead><tbody><tr><td>jdbc</td><td>æä¾›äº†sqlè¯­å¥ç”Ÿæˆå’Œæ‰§è¡Œçš„ç‹¬ç«‹åŠŸèƒ½</td><td></td></tr><tr><td>cache</td><td>æä¾›äº†å„ç§ç¼“å­˜ç­–ç•¥</td><td>åŒ…è£…å™¨æ¨¡å¼</td></tr><tr><td>transaction</td><td>äº‹åŠ¡çš„ç®¡ç†æä¾›äº†ä¸¤ç§æ–¹å¼ä¸€ç§æ˜¯åŸºäºjdbcçš„ä¸€ç§æ˜¯åŸºäºå®¹å™¨çš„</td><td>å·¥å‚</td></tr><tr><td>cursor</td><td>ç”¨æ¸¸æ ‡çš„æ–¹å¼è¿”å›æŸ¥è¯¢çš„ç»“æœæ•°æ®</td><td></td></tr><tr><td>executor</td><td>æ‰§è¡Œå™¨æ ¸å¿ƒç±»åŒ…å«äº†è‡ªå¢ä¸»é”®çš„ç”Ÿæˆã€æ‡’åŠ è½½(cglibçš„åŠ¨æ€ä»£ç†)ã€å‚æ•°/ç»“æœ/è¯­å¥å¤„ç†ç­‰</td><td>æ¨¡ç‰ˆæ–¹æ³•</td></tr><tr><td>session</td><td>ä¸»è¦æ˜¯Sqlsesisonçš„åˆ›å»º</td><td></td></tr><tr><td>plugin</td><td>ä¸»è¦æä¾›ParameterHandlerã€ResultSetHandlerã€StatementHandlerã€Executorç±»çš„æ’ä»¶æ‹¦æˆªå™¨</td><td>è´£ä»»é“¾</td></tr></tbody></table></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">Last update: </span><!----></div><div class="contributors"><span class="label">Contributors: </span><!--[--><!--[--><span class="contributor" title="email: 1073825890@qq.com">gaoqisen</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/sourcecode/mybatis-3-configParse.html" class="nav-link prev" aria-label="03_Mybatisæºç -é…ç½®è§£æ"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->03_Mybatisæºç -é…ç½®è§£æ</div></a><a href="/sourcecode/mybatis-5-sum.html" class="nav-link next" aria-label="05_Mybatisæºç -æ±‡æ€»"><div class="hint">Next<span class="arrow end"></span></div><div class="link">05_Mybatisæºç -æ±‡æ€»<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-f4339f74.js" defer></script>
  </body>
</html>
